---
title: "Stepping Stone Report Draft 1"
author: "Michele Claibourn, Elizabeth Mitchell, Nina Schoonover, Lee LeBoeuf"
date: "2023-05-02"
output: 
  html_document:
    # template: school-composition-template.html
    # theme:
      # base_font:
      #   google: "Poppins"
      # heading_font:
      #   google: "Oswald"
      # bootswatch: spacelab
      # version: 5
    # css: styles.css
    toc: true
    toc_float: true
# toc-title: Contents
---
```{css, echo=FALSE}
h1, h2, h3, h4, h5, h6 {
  padding-top: 1rem;
}
div.section.level4.tabset h4 {
  font-size: 24px;
}
h5, h6 {
  font-size: 18px;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(scales)
library(janitor)
library(ggthemes)
library(ggrepel)
library(bslib)

three_category_palette <- c("#E48073", "#2F7E9F", "#83DBD7")
two_category_palette <- c("#782C6A", "#83DBD7")
one_category_palette <- c("#782C6A")

# black/white/grayscale friendly
# three_category_palette <- c("#E57873", "#0D6A82", "#ADE9ED")
# two_category_palette <- c("#782C6A", "#ADE9ED")
# one_category_palette <- c("#782C6A")

```

## Introduction

### Approach

### Our Youth

### Contributions

## Education and Civic Engagement

### Kindergarteners at or above Kindergarten Readiness Levels {.tabset}

#### Trends

##### Percent of Incoming Kindergarteners meeting or screening above PALS benchmarks for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
pals_kinder <- read_csv("../data/pals_kindergarten_updated.csv")
pals_kinder <- pals_kinder %>% mutate(pct_invert = 100-percent)
pals_kinder_labels <- pals_kinder %>% 
  filter(location != "Virginia" & school_year == "2019-2020") %>%
  mutate(label = paste0(as.character(round(pct_invert, digits = 1)), "%"))

pals_kinder %>%
  ggplot(aes(x = school_year, y = pct_invert, color = location, group = location)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = pals_kinder_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Incoming Kindergarteners") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

Source: Annie E. Casey Foundation, Kids Count Data Center, "Fall PALS-K [before](https://datacenter.kidscount.org/data/tables/3254-fall-pals-k-before-2015-16) and [after](https://datacenter.kidscount.org/data/tables/10181-fall-pals-k-after-2015-16) 2015/16 in Virginia"

#### About


### Standards of Learning

#### Math: Grades 3, 5, and 8 {.tabset}

##### Trends

###### Percent of Students who Pass the 3rd Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Read in data
sols <- read_csv("../data/sol_pass.csv")
sols <- sols %>% 
  mutate(division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"))
miss2021 <- data.frame(division_name = c("Albemarle", "Charlottesville", "Virginia"),
                       school_year = c("2019-2020", "2019-2020", "2019-2020"))

sols_m3_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "Mathematics" & test_level == "Grade 3" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))
sols_m5_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "Mathematics" & test_level == "Grade 5" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))
sols_m8_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "Mathematics" & test_level == "Grade 8" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))

# Grade 3 Plot
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 3") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-2012", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_m3_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
  
```

Source: Virginia Department of Education (VDOE). 2006 - 2021. https://p1pe.doe.virginia.gov/buildatable/testresults
       
###### Percent of Students who Pass the 5th Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 5") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-2012", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_m5_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

###### Percent of Students who Pass the 8th Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 8") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-2012", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_m8_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### About

#### Reading: Grades 3, 5, and 8 {.tabset}

##### Trends
###### Percent of Students who Pass the 3rd Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# create labels for reading SOLs
sols_r3_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "English:Reading" & test_level == "Grade 3" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))
sols_r5_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "English:Reading" & test_level == "Grade 5" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))
sols_r8_labels <- sols %>% 
  filter(division_name != "Virginia" & subject == "English:Reading" & test_level == "Grade 8" & school_year == "2021-2022") %>% 
  mutate(label = paste0(as.character(round(pass_rate, digits = 1)), "%"))

# Grade 3 Reading Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 3") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-2013", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_r3_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

###### Percent of Students who Pass the 5th Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Grade 5 Reading Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 5") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-2013", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_r5_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

###### Percent of Students who Pass the 8th Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Grade 8 Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 8") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-2020", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-2013", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sols_r8_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### About

### Students Eligible for Special Education Services {.tabset}

#### Trends
##### Percent of Students Identified to Receive Special Services for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sped_services <- read_csv("../data/sped_services.csv")
sped_services <- sped_services %>% 
  mutate(division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"))
sped_services_labels <- sped_services %>% 
  filter(division_name != "Virginia" & school_year == "2021-2022") %>%
  mutate(label = paste0(as.character(round(percent_sped, digits = 1)), "%"))

sped_services %>% 
  ggplot(aes(x = school_year, y = percent_sped, 
             color = division_name, group = division_name)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = sped_services_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Enrolled Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### English Language-Learning Students {.tabset}

#### Trends
##### Percent of Students Identified as English Language Learners for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
english_language_learners <- read_csv("../data/english_language_learners.csv")
english_language_learners_labels <- english_language_learners %>% 
  filter(locality != "Virginia" & school_year == "2022-2023") %>%
  mutate(label = paste0(as.character(round(pct_english_learners, digits = 1)), "%"))

english_language_learners %>% 
  ggplot(aes(x = school_year, y = pct_english_learners, color = locality, group=locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = english_language_learners_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.4, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Enrolled Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Average Daily Attendance {.tabset}

#### Trends
##### Percent of Students in Attendance on an Average Day for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
average_daily_attendance <- read_csv("../data/average_daily_attendance.csv")
average_daily_attendance <- average_daily_attendance %>% 
  mutate(school_year = paste0(as.character(year-1), "-", as.character(year)))
average_daily_attendance_labels <- average_daily_attendance %>% 
  filter(name != "Virginia" & school_year == "2021-2022") %>%
  mutate(label = paste0(as.character(round(pct_att_total, digits = 1)), "%"))

average_daily_attendance %>%
  ggplot(aes(x = school_year, y = pct_att_total, color = name, group = name)) +
  geom_rect(aes(xmin = "2019-2020", xmax = "2020-2021", ymin = -Inf, ymax = Inf), alpha = .05, color = NA, fill = "#f5f5f5") +
  annotate("text", x = 10.2, y = 65, size = 3, hjust = 0, color = "#333333", 
           label = 
"School schedules 
impacted by 
COVID-19 Pandemic") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = average_daily_attendance_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(50, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "", fill = "")
```

### On-Time Graduation Rates {.tabset}

#### Trends
##### Percent of Student Cohort Graduating in Four Years for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
graduation_rates <- read_csv("../data/graduation_rates.csv")
graduation_rates <- graduation_rates %>% 
  mutate(school_year = as.character(cohort_year),
         division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"))
graduation_rates_labels <- graduation_rates %>% 
  filter(division_name != "Virginia" & school_year == "2022") %>%
  mutate(label = paste0(as.character(round(graduation_rate, digits = 1)), "%"))

graduation_rates %>%
  ggplot(aes(x = school_year, y = graduation_rate, color = division_name, group = division_name)) +
  # geom_vline(xintercept = "2013", linetype = 2, color = "black") +
#   annotate("text", x = 6.2, y = 55, size = 3, hjust = 0, color = "black", 
#            label = 
# "Charlottesville City Schools
# extend WALK program hours") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = graduation_rates_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Student Cohort") + 
  scale_x_discrete(name = "Graduation Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


### Post-Secondary Enrollment {.tabset}

#### Trends
##### Percent of Graduating Students Enrolled in a Post-Secondary Institution within 16 months of High School Graduation for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
postsecondary_education <- read_csv("../data/postsecondary_education.csv")

# pivot to stack 2 year and 4 year
df_long <- postsecondary_education %>% 
  mutate(enrolled4yr = enrolled4pub + enrolled4priv) %>% 
  select(year, locality, cohortsize, enrolled4yr, enrolled2yr, enrolledany) %>% 
  pivot_longer(cols = starts_with("enrolled"), names_to = "type", values_to = "number") %>% 
  mutate(percent = (number/cohortsize)*100,
         school_year = as.character(year))

df_long <- df_long %>% 
  filter(type != "enrolled2yr") %>% 
  mutate(type = recode(type,
                          "enrolled4yr" = "4-yr Institution",
                          "enrolledany" = "Any Institution"))

df_long_labels <- df_long %>% 
  filter(locality != "Virginia" & school_year == "2020") %>%
  mutate(label = paste0(as.character(round(percent, digits = 1)), "%"))

# keep only 4yr and any - or - 2yr and 4yr

df_long %>%
  ggplot(aes(x = school_year, y = percent, 
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = df_long_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1),
                     name = "Percent of Graduating Students") +
  scale_x_discrete(name = "Graduation Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "", linetype = "")
```

### High School Degree Attainment {.tabset}

#### Trends
##### Percent of Residents Age 25 and Older with a High School Degree or Equivalent in Albemarle County, City of Charlottesville, and Virginia
```{r}
hsdegree_attainment <- read_csv("../data/hsdegree_attainment.csv")
hsdegree_attainment <- hsdegree_attainment %>% 
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year)))
hsdegree_attainment_labels <- hsdegree_attainment %>% 
  filter(locality != "Virginia" & survey_period == "2016-2021") %>%
  mutate(label = paste0(as.character(round(pcthshigherE, digits = 1)), "%"))

hsdegree_attainment %>%
  ggplot(aes(x = survey_period, y = pcthshigherE, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = hsdegree_attainment_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(40, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Residents") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Registered Voters {.tabset}

#### Trends
##### Percent of Adults (18+) Registered to Vote in Albemarle County, City of Charlottesville, and Virginia
```{r}
voter_reg <- read_csv("../data/vote_reg.csv")
voter_reg <- voter_reg %>% 
  filter(year != 2021) %>% 
  mutate(year = as.character(year),
         locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville")) 
voter_reg_labels <- voter_reg %>% 
  filter(locality != "Virginia" & year == "2020") %>%
  mutate(label = paste0(as.character(round((reg_rate*100), digits = 1)), "%"))

voter_reg %>%
  ggplot(aes(x = year, y = reg_rate, color = locality, group = locality)) +
  geom_vline(xintercept = "2000", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2004", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2008", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2012", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2016", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2020", linetype = 2, color = "#333333") +
  annotate("text", x = 5.2, y = .3, size = 3, hjust = 0, color = "#333333", 
           label = 
"Presidential
Elections") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = voter_reg_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.6, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  # scale_x_continuous("Year", labels = as.character(year), breaks = year) + 
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent,
                     name = "Percent of Adults") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

## Economic Security and Housing

### Income Per Capita {.tabset}

#### Trends
##### Income Per Capita for Charlottesville and Albemarle Combined and Virginia
```{r}
per_cap_income <- read_csv("../data/per_cap_income.csv")
per_cap_income <- per_cap_income %>% 
  pivot_longer(cols = c("pci", "adj_pci"), names_to = "type", values_to = "number") %>%
  mutate(year = as.character(year),
         locality = recode(GeoName,
                           "Albemarle + Charlottesville, VA*" = "Albemarle + Charlottesville"),
         type = recode(type,
                       "pci" = "Raw Income",
                       "adj_pci" = "Inflation-Adjusted Income"))
per_cap_income_labels <- per_cap_income %>% 
  filter(locality != "Virginia" & year == "2021") %>%
  mutate(label = paste0(as.character(formatC(number, format="d", big.mark=","))))

per_cap_income %>%
  ggplot(aes(x = year, y = number,
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_rect(aes(xmin = "2007", xmax = "2009", ymin = -Inf, ymax = Inf), alpha = .05, color = NA, fill = "#f5f5f5") +
  annotate("text", x = 10.2, y = 80000, size = 3, hjust = 0, color = "#333333",
           label =
"Economic Recession 
(2007-2009)") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = per_cap_income_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.6, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_color_manual(values = two_category_palette) +
  scale_y_continuous(label = comma,
                     name = "Income Per Capita") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "", linetype = "", fill = "")
```

### Youth Labor Force Participation and Unemployment {.tabset}

#### Trends

##### Percent of Youth (15-24) Participating in the Labor Force for Albemarle County, City of Charlottesville, and Virginia
```{r}
youth_employment <- read_csv("../data/youth_employment_status.csv")

youth_employment <- youth_employment %>% 
  mutate(locality = recode(name,
                          "Albemarle County, Virginia" = "Albemarle",
                          "Charlottesville city, Virginia" = "Charlottesville"),
         survey_period = paste0(as.character(year-5), "-", as.character(year)))

youth_employment_labels <- youth_employment %>% 
  filter(locality != "Virginia" & survey_period == "2016-2021") %>%
  mutate(label = paste0(as.character(round((laborforce_rate), digits = 1)), "%"))

youth_employment %>%
  ggplot(aes(x = survey_period, y = laborforce_rate, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = youth_employment_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### Percent of Youth (15-24) in the Labor Force Experiencing Unemployment for Albemarle County, City of Charlottesville, and Virginia
```{r}
youth_unemployment_labels <- youth_employment %>% 
  filter(locality != "Virginia" & survey_period == "2016-2021") %>%
  mutate(label = paste0(as.character(round((unemployment_rate), digits = 1)), "%"))

youth_employment %>%
  ggplot(aes(x = survey_period, y = unemployment_rate, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(data = youth_unemployment_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth in Labor Force") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


### Children Living below Poverty Threshold {.tabset}

#### Trends
##### Percent of Children (0-17) Living below the Poverty Threshold for Albemarle County, City of Charlottesville, and Virginia
```{r}
child_poverty <- read_csv("../data/child_pov.csv")
child_poverty <- child_poverty %>%
  mutate(locality = ifelse(county_fips == "000", "Virginia",
                       ifelse(county_fips == "003", "Albemarle",
                              ifelse(county_fips == "540", "Charlottesville", "Unknown"))),
         year = as.character(year))
child_poverty_labels <- child_poverty %>% 
  filter(locality != "Virginia" & year == "2021") %>%
  mutate(label = paste0(as.character(round((pct_child_pov), digits = 1)), "%"))

child_poverty %>% 
  ggplot(aes(x = year, y = pct_child_pov, color = locality, group = locality)) +
  geom_vline(xintercept = "2020", linetype = 2, color = "black") +
  geom_vline(xintercept = "2021", linetype = 2, color = "black") +
  annotate("text", x = 16.8, y = 85, size = 3, hjust = 0, color = "black", 
           label = 
"COVID-19 Economic
Stimulus Payments") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = child_poverty_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.6, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Children") + 
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Students Identified as Economically Disadvantaged {.tabset}

#### Trends
##### Percent of Students Identified as Economically Disadvantaged (eligible for free or reduced meals, eligible for TANF, Medicaid and/or Head Start, or identified as from a migrant family, experiencing homelessness, or in foster care) for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
economically_disadvantaged_students <- read_csv("../data/economically_disadvantaged_students.csv")
economically_disadvantaged_students_labels <- economically_disadvantaged_students %>% 
  filter(division_name != "Virginia" & school_year == "2022-2023") %>%
  mutate(label = paste0(as.character(round((percent), digits = 1)), "%"))

economically_disadvantaged_students %>%
  ggplot(aes(x = school_year, y = percent, color = division_name, group = division_name)) +
#   geom_vline(xintercept = "2020", linetype = 2, color = "black") +
#   annotate("text", x = 16.8, y = 85, size = 3, hjust = 0, color = "black", 
#            label = 
# "COVID-19 Economic
# Stimulus Payments") +
  geom_line() +
  geom_point() +
  geom_text_repel(data = economically_disadvantaged_students_labels, aes(label = label),
                  size = 3, fontface = "bold", nudge_x = 1.3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


### Cost-Burdened Renters and Homeowners {.tabset}

#### Trends
##### Renters Paying more than 30% of their Income on Housing (Rent and Utilities)
```{r}
rent_burdened <- read_csv("../data/rent_burdened.csv")

rent_burdened %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year))) %>% 
  ggplot(aes(x = survey_period, y = percent_over_30, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent, 
                     name = "Percent of Renters") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


##### Homeowners Paying more than 30% of their Income on Housing (Mortgage payments, Taxes, Insurance, and Utilities)
```{r}
homeowner_burden <- read_csv("../data/homeowner_burden.csv")

homeowner_burden %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year))) %>% 
  ggplot(aes(x = survey_period, y = pct_burden, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Homeowners") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


### People Experiencing Homelessness {.tabset}

#### Trends
```{r}
pitcount_homeless <- read_csv("../data/pitcount_homeless.csv")

pitcount_homeless %>% 
  mutate(year = as.character(year),
         locality = "Charlottesville Region") %>% 
  ggplot() +
  geom_vline(xintercept = "2012", linetype = 2, color = "black") +
  annotate("text", x = 4.2, y = 100, size = 3, hjust = 0, color = "black", 
           label = 
"Opening of The Crossings
(permanent supportive housing)") +
  geom_vline(xintercept = "2022", linetype = 2, color = "black") +
  annotate("text", x = 10.2, y = 275, size = 3, hjust = 0, color = "black", 
           label = 
"COVID-19 pandemic hightened
impact of high housing costs 
and lack of affordable housing") +
  geom_line(aes(x = year, y = count, 
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_point(aes(x = year, y = count,
             color = locality, 
             group = interaction(locality, type), 
             linetype = type), ) +
  scale_linetype_manual(values = c(2, 1, 6)) +
  scale_color_manual(values = one_category_palette) +
  scale_y_continuous(limits = c(0,300),
                     label = comma,
                     name = "Number of People") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "", linetype = "", fill = "")
```


## Health and Family Stability

### Mothers with Access to Prenatal Care {.tabset}

#### Trends
```{r}
prenatal_first_trimester <- read_csv("../data/prenatal_first_trimester.csv")

prenatal_first_trimester %>%
  mutate(percent_access_to_prenatal_care = 100 - late_no_prenatal_to_birthrates,
          year = as.character(year)) %>%
  ggplot(aes(x = year, y = percent_access_to_prenatal_care, color = locality, group = locality)) +
  geom_vline(xintercept = "2010", linetype = 2, color = "black") +
  annotate("text", x = 5.2, y = 80, size = 3, hjust = 0, color = "black", 
           label = 
"Affordable Care 
Act (ACA) passed") +
  geom_vline(xintercept = "2019", linetype = 2, color = "black") +
  annotate("text", x = 11.5, y = 85, size = 3, hjust = 0, color = "black", 
           label = 
"Virginia expanded 
Medicaid coverage") +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(40, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Mothers") + 
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Low Birth-Weight Births {.tabset}

#### Trends
```{r}
low_birth_weight <- read_csv("../data/low_birth_weight.csv")

low_birth_weight %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         # year = as.character(year),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1))) %>% 
  ggplot(aes(x = three_yr_period, y = pct_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Avg. Percent of Babies") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Infant Deaths {.tabset}

#### Trends
```{r}
infant_mortality <- read_csv("../data/infant_mortality.csv")

infant_mortality %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1))) %>% 
  ggplot(aes(x = three_yr_period, y = rate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Avg. Percent of Babies") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

<!-- ### Births to mothers with less than a 12th grade education {.tabset} -->

<!-- #### Trends -->
<!-- ```{r} -->
<!-- births_mothers_nohs <- read_csv("../data/births_mothers_nohs.csv") -->

<!-- births_mothers_nohs %>% -->
<!--   mutate(year = as.character(year)) %>% -->
<!--   ggplot(aes(x = year, y = percent, color = location, group = location)) + -->
<!--   geom_vline(xintercept = "2008", linetype = 2, color = "black") + -->
<!--   annotate("text", x = 9.2, y = 40, size = 3, hjust = 0, color = "black", -->
<!--            label = -->
<!-- "FDA lowers OTC Emergency  -->
<!-- Contraceptive Age to 17") + -->
<!--   geom_line() + -->
<!--   geom_point() + -->
<!--   scale_color_manual(values = three_category_palette) + -->
<!--   scale_y_continuous(limits = c(0, 100), -->
<!--                      labels = label_percent(scale = 1),  -->
<!--                      name = "Percent of Mothers") +  -->
<!--   scale_x_discrete(name = "Year") + -->
<!--   theme_minimal() + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") + -->
<!--   labs(color = "") -->
<!-- ``` -->

### Teen Pregnancies, Births to Teens {.tabset}

#### Trends
##### Rate of Teen Prenancies
```{r}
teen_pregnancy_birth_rates <- read_csv("../data/teen_pregnancy_birth_rates.csv")

teen_pregnancy_birth_rates %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1))) %>% 
  ggplot(aes(x = three_yr_period, y = pregnancyrate_3yr, color = locality, group = locality)) +
#   geom_vline(xintercept = "2008-2010", linetype = 2, color = "black") +
#   annotate("text", x = 10.2, y = 60, size = 3, hjust = 0, color = "black",
#               label = 
# "2008 FDA lowers OTC 
# Emergency Contraceptive 
# Age to 17") +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     # labels = label_percent(scale = 1), 
                     name = "Rate per 1,000") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### Rate of Births to Teens
```{r}
teen_pregnancy_birth_rates %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1))) %>% 
  ggplot(aes(x = three_yr_period, y = birthsrate_3yr, color = locality, group = locality)) +
#   geom_vline(xintercept = "2008-2010", linetype = 2, color = "black") +
#   annotate("text", x = 10.2, y = 60, size = 3, hjust = 0, color = "black",
#               label = 
# "2008 FDA lowers OTC 
# Emergency Contraceptive 
# Age to 17") +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     # labels = label_percent(scale = 1), 
                     name = "Rate per 1,000") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Sexually Transmitted Infections in Youth {.tabset}

#### Trends
```{r}
youth_sti <- read_csv("../data/youth_sti.csv")

youth_sti %>%
  ggplot(aes(x = year3, y = total_incrate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     # labels = label_percent(scale = 1), 
                     name = "Rate per 1,000 youth") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Children in Two-Parent Households {.tabset}

#### Trends
```{r}
children_twoparents <- read_csv("../data/children_twoparents.csv")

children_twoparents %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year))) %>% 
  ggplot(aes(x = survey_period, y = percent, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent, 
                     name = "Percent of Children") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Divorce {.tabset}

#### Trends
##### Divorce Rate, Source: Virginia Circuit Court
```{r}
divorce_circuit <- read_csv("../data/divorce_circuit.csv")
dc_missing <- data.frame(locality = c("Virginia", "Virginia", "Virginia", "Virginia", "Virginia", "Virginia"),
                       year = c(2014, 2015, 2016, 2017, 2018, 2019))

divorce_circuit %>% 
  bind_rows(dc_missing) %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = divorce_rate, 
             color = locality, 
             group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,10),
                     breaks = c(0,2,4,6,8,10),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### Divorce Rate, Source: Virginia Department of Health
```{r}
divorce_vdh <- read_csv("../data/divorce_vdh.csv")

divorce_vdh %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = divorce_rate, 
             color = locality, 
             group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,10),
                     breaks = c(0,2,4,6,8,10),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Investigations and Assessments by Child Protective Services {.tabset}

#### Trends
```{r}
child_welfare_reports <- read_csv("../data/child_welfare_reports.csv")

child_welfare_reports %>%
  mutate(fiscal_year = paste0(as.character(year-1),"-",as.character(year)),
         year = as.character(year)) %>% 
  ggplot(aes(x = year, y = cps_rate, 
             color = locality, 
             group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000") +
  scale_x_discrete(name = " Fiscal Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


### Children in Foster Care {.tabset}

#### Trends
```{r}
foster_care <- read_csv("../data/foster_care.csv")

foster_care %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = fc_rate, 
             color = locality, 
             group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000") +
  scale_x_discrete(name = " Fiscal Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```


## School and Community Disciplinary Actions

### School Reports of Discipline {.tabset}

#### Trends
##### Alcohol and Drug Offenses
```{r}
school_alcdrugs_dcv <- read_csv("../data/school_alcdrugs_dcv.csv")

school_alcdrugs_dcv %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### Physical Violence
```{r}
school_violence_byoffense_dcv <- read_csv("../data/school_violence_byoffense_dcv.csv")
sv_missing <- data.frame(division = c("Virginia", "Virginia", "Virginia", "Virginia",
                                      "Charlottesville", "Charlottesville", "Charlottesville", "Charlottesville",
                                      "Albemarle", "Albemarle", "Albemarle", "Albemarle"),
                       school_year = c("2013-2014", "2014-2015", "2015-2016", "2016-2017",
                                      "2013-2014", "2014-2015", "2015-2016", "2016-2017",
                                      "2013-2014", "2014-2015", "2015-2016", "2016-2017"))

school_violence_byoffense_dcv %>%
  bind_rows(sv_missing) %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

##### Weapons Possession
```{r}
school_weapons_dcv <- read_csv("../data/school_weapons_dcv.csv")

school_weapons_dcv %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### School Suspensions {.tabset}

#### Trends
##### Students given an out-of-school suspension (short-term suspension, long-term suspension, or modified expulsion to suspension) per 1000 students enrolled
```{r}
school_suspensions <- read_csv("../data/school_suspensions.csv")

school_suspensions %>%
  ggplot() +
  geom_line(aes(x = school_year, y = rate, 
             color = division, 
             group = interaction(division, source), 
             linetype = source)) +
  geom_point(aes(x = school_year, y = rate, 
             color = division, 
             group = interaction(division, source), 
             linetype = source), ) +
  scale_color_manual(values = three_category_palette) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_y_continuous(limits = c(0,500),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "", linetype = "")
```


### Children in Need of Supervision {.tabset}

#### Trends
```{r}
child_need_services <- read_csv("../data/child_need_services.csv")

child_need_services %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Juvenile Delinquency Judgments {.tabset}

#### Trends
```{r}
juvenile_delinquency <- read_csv("../data/juvenile_delinquency.csv")

juvenile_delinquency %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,150),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Underage Alcohol Arrests {.tabset}

#### Trends
```{r}
arrests_alcoholrelated <- read_csv("../data/arrests_alcoholrelated.csv")

arrests_alcoholrelated %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = arr_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

### Arrests for Violent Crimes {.tabset}

#### Trends
```{r}
arrests_crimesagainstpersons <- read_csv("../data/arrests_crimesagainstpersons.csv")

arrests_crimesagainstpersons %>%
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = arr_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="top") +
  labs(color = "")
```

## Disaggregated by Race
### School Suspensions  {.tabset}

#### Trends
```{r}

library(stats)
library(ggpubr)
library(plotrix)

# reading in data
nonprekVAall <- read.csv("../data/school_suspension_CRDCnonprek.csv")

nonprekVAall$OSS_Total <- rowSums(nonprekVAall[,c('OSS_Black','OSS_Hispanic','OSS_White','OSS_TwoOrMore', 'OSS_Asian')], na.rm = T)

nonprekVAall$totalstudents <- nonprekVAall$num_Total

nonprekVAall <- nonprekVAall %>%
  filter(Year != 2009)

## Re-shaping them to long format 
k12long_count_oss <- pivot_longer(nonprekVAall, cols = c('num_Black', 'num_Hispanic', 'num_White',
                                                         'num_TwoOrMore', 'num_Asian', 'num_Total',
                                                         'OSS_Black', 'OSS_Hispanic', 'OSS_White',
                                                         'OSS_TwoOrMore','OSS_Asian', 'OSS_Total'),
                                  names_to = c('.value','Race'),
                                  names_pattern = '(.+)_(Black|White|Hispanic|Asian|TwoOrMore|Total)')

k12long_count_oss$Race <- ifelse(k12long_count_oss$Race == "TwoOrMore", "Two or more", k12long_count_oss$Race)

# Calculating the percent of students suspended in each racial group 
k12long_count_oss$percsus <- round(k12long_count_oss$OSS / k12long_count_oss$num * 100, 2)
# Calculating the percent of the students enrolled in each racial group 
k12long_count_oss$percenroll <- round(k12long_count_oss$num / k12long_count_oss$totalstudents * 100, 2)

# Making NA rows for breaking up lines in ggplot 
# with the new way I code years later, 2010, 2012, 2014, and 2016 should all be NA years
yrs <- c(2012, 2014, 2016)
blanks <- data.frame(n = 1:3)
cols <- c("Year", "Race", "meanpercsus", "se", "meanperenroll", "meanenroll", "totalsus", "lessthan")
blanks[cols] <- NA
blanks$Year <- yrs
blanks <- blanks %>%
  select(-n)

# Calculating means by race and year for plotting 
k12OSSmeans <- k12long_count_oss %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(k12OSSmeans$Year), totalsus = k12OSSmeans$meanpercsus[k12OSSmeans$Race == "Total"])
k12OSSmeans <- merge(k12OSSmeans, totalsusovertime, by = 'Year')
k12OSSmeans$lessthan <- ifelse(k12OSSmeans$meanenroll < (100 / k12OSSmeans$totalsus), TRUE, FALSE)
k12OSSmeans <- k12OSSmeans %>%
  filter(lessthan == FALSE)

k12OSSmeans <- rbind(k12OSSmeans, blanks)

k12OSSmeans$Locality <- "Virginia"

# Charlottesville = CHARLOTTESVILLE CTY PBLC SCHS
# Albemarle = ALBEMARLE CO PBLC SCHS

albk12 <- k12long_count_oss %>%
  filter(LEA == "ALBEMARLE CO PBLC SCHS")

cvillek12 <- k12long_count_oss %>%
  filter(LEA == "CHARLOTTESVILLE CTY PBLC SCHS")

# Albemarle
# Calculating means by race and year for plotting 
albk12OSSmeans <- albk12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(albk12OSSmeans$Year), totalsus = albk12OSSmeans$meanpercsus[albk12OSSmeans$Race == "Total"])
albk12OSSmeans <- merge(albk12OSSmeans, totalsusovertime, by = 'Year')
albk12OSSmeans$lessthan <- ifelse(albk12OSSmeans$meanenroll < (100 / albk12OSSmeans$totalsus), TRUE, FALSE)
albk12OSSmeans <- albk12OSSmeans %>%
  filter(lessthan == FALSE)

albk12OSSmeans <- rbind(albk12OSSmeans, blanks)

albk12OSSmeans$Locality <- "Albemarle"

# creating weird year variable for plotting
albk12OSSmeans$Year <- ifelse(albk12OSSmeans$Year == 2011, 2011.5,
                                     ifelse(albk12OSSmeans$Year == 2013, 2013.5,
                                            ifelse(albk12OSSmeans$Year == 2015, 2015.5,
                                                   ifelse(albk12OSSmeans$Year == 2017, 2017.5, albk12OSSmeans$Year))))

# Cville
cvillek12OSSmeans <- cvillek12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(cvillek12OSSmeans$Year), totalsus = cvillek12OSSmeans$meanpercsus[cvillek12OSSmeans$Race == "Total"])
cvillek12OSSmeans <- merge(cvillek12OSSmeans, totalsusovertime, by = 'Year')
cvillek12OSSmeans$lessthan <- ifelse(cvillek12OSSmeans$meanenroll < (100 / cvillek12OSSmeans$totalsus), TRUE, FALSE)
cvillek12OSSmeans <- cvillek12OSSmeans %>%
  filter(lessthan == FALSE)

cvillek12OSSmeans <- rbind(cvillek12OSSmeans, blanks)

cvillek12OSSmeans$Locality <- "Charlottesville"

# creating weird year variable for plotting
cvillek12OSSmeans$Year <- ifelse(cvillek12OSSmeans$Year == 2011, 2010.5,
                                     ifelse(cvillek12OSSmeans$Year == 2013, 2012.5,
                                            ifelse(cvillek12OSSmeans$Year == 2015, 2014.5,
                                                   ifelse(cvillek12OSSmeans$Year == 2017, 2016.5, cvillek12OSSmeans$Year))))

dat <- rbind(k12OSSmeans, albk12OSSmeans, cvillek12OSSmeans)

### Plots 
# all levels together 
# ggplot() + geom_point(data = dat, aes(Year, meanpercsus, shape = Locality, color = Race),
#                       position = 'identity', size = 3) + 
#   geom_line(data = dat,aes(x = Year, y = meanpercsus, group = Locality),
#             color = 'gray') +
#   xlab("Year") + ylab("Average % of students receiving OSS")  + 
#   ggtitle("") + scale_x_continuous(breaks = seq(2011, 2017, by = 2)) + 
#   theme_bw()+ 
#   scale_colour_discrete(na.translate = F) +
#   labs(caption = "Note: Racial groups were only included for a given year and locality when the average
#        number of students enrolled was high enough such that you would expect to see at least one suspension
#        if the average overall rate were true for each racial group")+
#   theme(plot.caption = element_text(hjust=0))


### Plots  adjust shape and color
## years are fall year, create school year +1
# all levels together 
dat %>% 
ggplot(aes(x = Year, y = meanpercsus, group = Locality, shape = Race, color = Locality)) + 
  geom_line(color = "grey") +
  geom_point(position = 'identity', size = 3) + 
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,20),
                     breaks = seq(0, 20, by = 5),
                     labels = label_percent(scale = 1)) +
  xlab("School Year") + ylab("Average % of students receiving OSS")  + 
  ggtitle("") + scale_x_continuous(breaks = seq(2011, 2017, by = 2)) + 
  theme_minimal() +
  labs(caption = "Note: Racial groups were only included for a given year and locality when the average
       number of students enrolled was high enough such that you would expect to see at least one suspension
       if the average overall rate were true for each racial group")+
  theme(plot.caption = element_text(hjust=0))


```

## Contributions
