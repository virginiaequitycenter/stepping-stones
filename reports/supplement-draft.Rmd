---
title: "Stepping Stones Supplement Sandbox"
output:
  # pdf_document:
  html_document:
    # template: school-composition-template.html
    theme:
      version: 5
    # css: styles.css
    toc: true
    toc_depth: 3
    toc_float: true
# toc-title: Contents
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(scales)
library(janitor)
library(ggthemes)
library(ggrepel)
library(bslib)
library(stringr)
library(grid)
library(ggnewscale)

str_sort_last <- function(object){
  last <- str_sort(object)
  last <- tail(last, 1)
  last
}

# three_category_palette <- c("#E57873", "#146A94", "#58C9AB")
# two_category_palette <- c("#782C6A", "#58C9AB")
# one_category_palette <- c("#782C6A")

# web colors
three_category_palette <- c("#E48073", "#2F7E9F", "#83DBD7")
two_category_palette <- c("#782C6A", "#83DBD7")
one_category_palette <- c("#782C6A")

seven_colors_race <- c(
"#0cc0aa",
"#58a2ee",
"#a942be",
# "#cf80dd",
"#E0004E",
"#ffa600",
"#2d5192",
# "#9112B8",
"#b69cfd"
)

two_colors_ethn <- c(
  # "#cf80dd",
  "#D3D3D3", 
  "#860967")


```

## Youth Population in Albemarle County, City of Charlottesville and Statewide by Race and Ethnicity 

### Racial breakdown of youth population in each locality in 2021

```{r fig.height=6.5, fig.width=10}
# Showing the youth population racial and enthic demographics for the stepping stone supplemental report
# Contributor: Lee LeBoeuf

# reading in data
popdat <- read.csv("../data/pop_race_ethn.csv") %>%
  rename(race = variable) %>%
  filter(year == 2021) %>% 
  clean_names() %>% 
  mutate(locality = factor(name, levels = c("Virginia", "Charlottesville city, Virginia", "Albemarle County, Virginia"), labels = c("Virginia", "Charlottesville", "Albemarle")))
           
         #   recode(name, "Albemarle County, Virginia" = "Albemarle",
         #                   "Charlottesville city, Virginia" = "Charlottesville",
         #                   "Virginia" = "Virginia")
         # )

# popdat <- popdat %>% 
#   mutate(race = factor(race, levels = c("white", "black", "multi", "asian", "other", "aian", "nhpi", "hispanic"), labels = c("White", "Black", "Multiracial", "Asian", "Other Races", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Hispanic")),
#          # recode(race, "aian" = "American Indian/Alaskan Native",
#          #              "asian" = "Asian",
#          #              "black" = "Black",
#          #              "multi" = "Multiracial",
#          #              "nhpi" = "Native Hawaiian/Pacific Islander",
#          #              "other" = "Other Races",
#          #              "white" = "White",
#          #              "hispanic" = "Hispanic"),
#          locality = factor(locality, levels = c("Virginia", "Charlottesville", "Albemarle"), labels = c("Virginia", "Charlottesville", "Albemarle"))
#            
#         
#          ) 


# dataframe for race
popdatrace <- popdat %>%
  filter(raceethn == 'race') %>%
  group_by(locality) %>%
  mutate(totalyouthpop = sum(youthpop_count)) %>%
  ungroup()

popdatrace$youthperc <- round(popdatrace$youthpop_count / popdatrace$totalyouthpop * 100, 2)
popdatrace$allperc <- round(popdatrace$pop_count / popdatrace$totalpop * 100, 2)

# dataframe for ethnicity 
popdatethn <- popdat %>%
  group_by(locality) %>%
  mutate(totalyouthpop = sum(youthpop_count)) %>%
  ungroup()

popdatethn <- popdatethn %>%
  group_by(raceethn, locality) %>%
  mutate(groupcount = sum(youthpop_count)) %>%
  select(locality, groupcount, totalyouthpop) %>%
  distinct()

popdatethn$ethnicity <- ifelse(popdatethn$raceethn == "ethnicity", "Hispanic", "Non-Hispanic")

popdatethn$youthperc <- round(popdatethn$groupcount / popdatethn$totalyouthpop * 100, 2)

# plots -- stacked bars faceted by locality 

###### Race ######
# youth plot 
popdatrace %>% 
  mutate(race = factor(race, 
                       levels = c("white", "black", "multi", "asian", "other", "aian", "nhpi", "hispanic"), 
                       labels = c("White", "Black", "Multiracial", "Asian", "Other Racial Identities", "American Indian/Alaskan Native", "Native Hawaiian/Pacific Islander", "Hispanic")),
         label = ifelse(youthperc >= 1, paste0(as.character(round(youthperc, digits = 0)), "%"), paste0(as.character(round(youthperc, digits = 1)), "%"))) %>% 
  arrange(race) %>% 
  ggplot(aes(x = youthperc, y = locality, group = locality, fill = race)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = label),
                  size = 3.5, fontface = "bold", show.legend = FALSE,
                  min.segment.length = Inf,
                  position = position_stack(vjust = 0.45), 
                  box.padding = 0.1,
                  force_pull = 100,
                  # direction = "x",
                  color = "white") +
  # geom_text(size = 4, position = position_stack(vjust = 0.5), color = "white") +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Population",
                     sec.axis = dup_axis()) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = c(seven_colors_race
    # "#D4A6C8", "#FCC66D", "#8CD17D", "#A0CBE8", "#E15759", "#5C6068", "#D3D3D3"
    )) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-10)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(fill = "")



```

### Ethnic breakdown of youth population in each locality in 2021

```{r}
###### Ethnicity ######
# youth plot 
popdatethn %>%
  mutate(ethnicity = factor(ethnicity, levels = c("Non-Hispanic", "Hispanic"), labels = c("Non-Hispanic", "Hispanic")),
         label = ifelse(youthperc >= 1, paste0(as.character(round(youthperc, digits = 0)), "%"), paste0(as.character(round(youthperc, digits = 1)), "%"))) %>% 
  arrange(ethnicity) %>% 
ggplot(aes(x = youthperc, y = locality, group = locality, fill = ethnicity, label = label)) +
  geom_bar(stat = "identity") +
  geom_label_repel(aes(label = label),
                  size = 3.5, fontface = "bold", show.legend = FALSE,
                  # min.segment.length = Inf,
                  position = position_stack(vjust = 0.5), 
                  box.padding = 0.05,
                  force_pull = 100,
                  direction = "x",
                  color = "white") +
  # geom_text(size = 4, position = position_stack(vjust = 0.5), color = "white") +
  scale_x_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Population",
                     sec.axis = dup_axis()) + 
  scale_y_discrete(name = "") +
  scale_fill_manual(values = two_colors_ethn) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-10)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(fill = "")

```


## Children Living Below Poverty Threshold

```{r fig.height=14, fig.width=10}
################# Children Living Below Poverty Threshold #################

# reading in data
povbyrace <- read.csv("../data/child_pov_byRace.csv") %>%
  rename(locality = NAME) %>%
  filter(race != "aian" & race != "nhpi" & race != "hispanic" & race != "other") %>% # all NA's for hispanic
  # filter(GEOID != 51) %>%  # filtering out VA 
  clean_names() %>%
  mutate(locality = factor(locality, levels = c("Albemarle County, Virginia", "Charlottesville city, Virginia", "Virginia"), labels = c("Albemarle", "Charlottesville", "Virginia"))
         
         ) %>% 
  select(c(year, locality, race, pov_count, pov_percent))

# getting totals 
povtot <- read.csv("../data/child_pov.csv") %>%
  # filter(county_fips != 0) %>% # filtering out VA
  filter(year >= 2010) %>%  # only have data by race for 2010 and later 
  clean_names() %>% 
  mutate(locality = ifelse(county_fips == 3, "Albemarle",
                          ifelse(county_fips == 540, "Charlottesville", "Virginia")),
         race = "Total",
         pov_count = num_child_pov, 
         pov_percent = pct_child_pov) %>% 
  select(c(year, locality, race, pov_count, pov_percent))

plot_child_pov <- rbind(povbyrace, povtot)

plot_child_pov <- plot_child_pov %>% 
  mutate(race = factor(race, 
                       levels = c("asian", "black", "multi", "white", "Total"),
                       labels = c("Asian", "Black", "Multiracial", "White", "Total")),
         year_space = ifelse(locality == "Virginia", year - 0.3, 
                       ifelse(locality == "Albemarle", year + 0.3, 
                              year)))


plot_child_pov <- plot_child_pov %>% 
  mutate(pt_label = substr(race, 1,1)) 
# %>% 
#   filter(year %in% c(2011,2013,2015,2017,2019,2021)) # reduce to odd years only

plot_poverty_gaps <- ggplot() + 
  #   geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2020, ymax = 2022), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2016, ymax = 2018), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2012, ymax = 2014), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_point(data = plot_child_pov, aes(x = pov_percent, y = year_space, group = year_space, col = race), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 6)) +
  new_scale_color() +
  geom_line(data = plot_child_pov, aes(x = pov_percent, y = year_space, group = year_space, color = locality), size = 0.8) +
  geom_point(data = plot_child_pov, aes(x = pov_percent, y = year_space, group = year_space, color = locality), position = 'identity', size = 7) +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 65),
                     expand = expansion(mult = c(.075, .02)),
                     breaks = seq(0, 65, by = 10),
                     labels = label_percent(scale = 1),
                     name = "Percent of Youth",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .02)),
                     breaks = seq(2010, 2021, by = 1),
                     name = "Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(data = plot_child_pov, aes(x = pov_percent, y = year_space, group = year_space, label = pt_label, col = race), size = 4) +
  scale_color_manual(values=rep("white",6)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-38)),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top"
        )

g <- ggplotGrob(plot_poverty_gaps)
lbls <- c("A", "B", "M", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

# g$grobs[[grep("guide", g$layout$name)]]

```


### Percent of Youth Living in Poverty by Race, 2010-2021 

```{r fig.height=8, fig.width=10}
# Creating data viz for stepping stones supplemental report by race 
# removing NHPI and AIAN for all plots because they represent such a small portion of the population 
# Contributor: Lee LeBoeuf

library(stats)
library(plotrix)


################# Children Living Below Poverty Threshold #################

# reading in data
povbyrace <- read.csv("../data/child_pov_byRace.csv") %>%
  rename(locality = NAME) %>%
  filter(race != "aian" & race != "nhpi" & race != "hispanic" & race != "other" ) %>% # all NA's for hispanic
  filter(GEOID != 51) %>%  # filtering out VA 
  clean_names() %>%
  mutate(locality = factor(locality, levels = c("Virginia", "Charlottesville city, Virginia", "Albemarle County, Virginia"), labels = c("Virginia", "Charlottesville", "Albemarle")),
         race = factor(race, 
                       levels = c("asian", "black", "multi", "white"), 
                       labels = c("Asian", "Black", "Multiracial", "White")),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         paste0(as.character(round(pov_percent, digits = 0)), "%"), NA)) %>% 
  filter(year >= 2011) # start at 2011 to reflect years in gap chart

# getting totals 
povtot <- read.csv("../data/child_pov.csv") %>%
  filter(county_fips != 0) %>% # filtering out VA
  filter(year >= 2011) %>%  # only have data by race for 2010 and later // start at 2011
  clean_names() %>% 
  mutate(locality = ifelse(county_fips == 3, "Albemarle",
                          ifelse(county_fips == 540, "Charlottesville", county_fips)),
         race = "Total")

# povtot$Locality <- ifelse(povtot$county_fips == 3, "Albemarle",
#                           ifelse(povtot$county_fips == 540, "Charlottesville", povtot$county_fips))
# 
# povtot$Race <- "Total"

# Plot 

ggplot() + 
  geom_line(data = povbyrace, aes(x = year, y = pov_percent, color = race), linewidth = 0.8) +
  geom_point(data = povbyrace, aes(x = year, y = pov_percent, color = race)) +
  geom_text_repel(data = povbyrace, aes(x = year, y = pov_percent, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c(
       "#E0004E", "#58a2ee", "#a942be", "#0cc0aa"
    # "#82BAFF", "#FCC66D", "#ef5675", "#cf80dd", "#0cc0aa"
    # "#FCC66D", "#8CD17D", "#A0CBE8", "#E15759", "#D4A6C8"
    # "#2d5192", "#387472", "#82d1f4", "#b69cfd", "#0cc0aa"
    )
    ) + 
  new_scale_color() +
  geom_line(data = povtot, aes(year, pct_child_pov, color = race), linewidth = 0.8, linetype = "dashed") +
  # geom_point(data = povtot, aes(year, pct_child_pov, color = race)) +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 80),
                     expand = expansion(mult = c(.03, .02)),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth") + 
  scale_x_continuous(breaks = seq(from = 2011, to = 2021, by = 1),
                     name = "Year") +
  # xlab("Year") + 
  # ylab("Percent of Youth") + 
  theme_minimal() + 
  # ggtitle("Percent of youth living in poverty by race") + 
  facet_wrap(~ locality, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

# white: "#0cc0aa"
# black: "#387472"
# multiracial: "#82d1f4"
# asian: "#2d5192"
# hispanic: "#860967"
# other:"#b69cfd"

```

### Percent of Youth Living in Poverty by Race in 2021

```{r fig.height = 9, fig.width=10}
# Creating data viz for stepping stones supplemental report by race 
# removing NHPI and AIAN for all plots because they represent such a small portion of the population 
# Contributor: Lee LeBoeuf

library(tidyverse)
library(stats)
library(plotrix)


################# Children Living Below Poverty Threshold #################

# reading in data
povbyrace <- read.csv("../data/child_pov_byRace.csv") %>%
  rename(Race = race,
         Locality = NAME) %>%
  filter(Race != "aian" & Race != "nhpi" & Race != "hispanic" & Race != "other" ) %>% # all NA's for hispanic
  filter(year == 2021)

povbyrace$Race <- recode(povbyrace$Race, 
                   "asian" = "Asian",
                   "black" = "Black",
                   "multi" = "Multiracial",
                   # "other" = "Other Racial Identities",
                   "white" = "White", 
                   "hispanic" = "Hispanic")

povbyrace$Locality <- recode(povbyrace$Locality, 
                         "Albemarle County, Virginia" = "Albemarle",
                         "Charlottesville city, Virginia" = "Charlottesville")
povbyrace <- povbyrace %>% 
  mutate(label = ifelse(year %in% str_sort_last(year),
                         paste0(as.character(round(pov_percent, digits = 0)), "%"), NA))

# getting totals 
povtot <- read.csv("../data/child_pov.csv") %>%
  filter(year == 2021)
povtot$Locality <- ifelse(povtot$county_fips == 0, "Virginia", 
                          ifelse(povtot$county_fips == 3, "Albemarle",
                                 ifelse(povtot$county_fips == 540, "Charlottesville", povtot$county_fips)))


# Plot 
ggplot() + 
  geom_col(data = povbyrace, aes(y = pov_percent, x = Locality, fill = Locality)) + 
  geom_text(data = povbyrace, aes(y = pov_percent, x = Locality, color = Locality, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = povtot, aes(y = pct_child_pov, x = Locality, color = "% of Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("% of Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth") + 
  scale_x_discrete(name = "") +
  # ggtitle("Percent of youth living in poverty by race in 2021") + 
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        # panel.grid.major.x = element_blank(),
        # text = element_text(size = 14),
        strip.text.x = element_text(size = 16),
        # strip.background = element_rect(fill = "grey90", linewidth = 0),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        # axis.text.y = element_text(margin = margin(r=-10)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        # axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        # plot.title = element_text(size = 16),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
# Charlottesville has 0 for Other race, it's not a missing value 
```

## Students Identified as Economically Disadvantaged

```{r fig.height=14, fig.width=10}
# reading in data
econbyrace <- read.csv("../data/econ_disad_students_Race.csv") %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Unknown - Race/Ethnicity not provided" &
           race != "Native Hawaiian  or Pacific Islander") %>%
  # filter(division_name != "Virginia") %>%
  filter(school_year != "2003-2004") %>%  # The total data doesn't include this year
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City", "Virginia"), labels = c("Albemarle", "Charlottesville", "Virginia")),
         plot_year = as.numeric(substr(school_year, 6, 9))) %>% 
  select(c(school_year, division_name, race, econdis_students, percent, plot_year))

# getting totals 
econtot <- read.csv("../data/economically_disadvantaged_students.csv") %>% 
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City", "Virginia"), labels = c("Albemarle", "Charlottesville", "Virginia")),
         race = "Total",
         econdis_students = economically_disadvantaged_students,
         plot_year = as.numeric(substr(school_year, 6, 9))) %>% 
  select(c(school_year, division_name, race, econdis_students, percent, plot_year))

plot_econ_disadvan <- rbind(econbyrace, econtot)

plot_econ_disadvan <- plot_econ_disadvan %>% 
  mutate(race = factor(race, 
                       levels = c("Asian", "Black, not of Hispanic origin", "Hispanic", "Non-Hispanic, two or more races", "White, not of Hispanic origin", "Total"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total")),
         year_space = ifelse(division_name == "Virginia", plot_year - 0.3, 
                       ifelse(division_name == "Albemarle", plot_year + 0.3, 
                              plot_year)))


plot_econ_disadvan <- plot_econ_disadvan %>% 
  mutate(pt_label = substr(race, 1,1)) %>%
  filter(plot_year >= 2014) # starts with 2004-2005 school year

plot_econ_gaps <- ggplot() + 
  #   geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2020, ymax = 2022), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2016, ymax = 2018), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2012, ymax = 2014), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_point(data = plot_econ_disadvan, aes(x = percent, y = year_space, group = year_space, col = race), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 6)) +
  new_scale_color() +
  geom_line(data = plot_econ_disadvan, aes(x = percent, y = year_space, group = year_space, color = division_name), size = 0.8) +
  geom_point(data = plot_econ_disadvan, aes(x = percent, y = year_space, group = year_space, color = division_name), position = 'identity', size = 7) +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 100),
                     expand = expansion(mult = c(.075, .02)),
                     breaks = seq(0, 100, by = 10),
                     labels = label_percent(scale = 1),
                     name = "Percent of Students",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .02)),
                     breaks = seq(2014, 2023, by = 1),
                     name = "School Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(data = plot_econ_disadvan, aes(x = percent, y = year_space, group = year_space, label = pt_label, col = race), size = 4) +
  scale_color_manual(values=rep("white",6)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-38)),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top"
        )

g <- ggplotGrob(plot_econ_gaps)
lbls <- c("A", "B", "H", "M", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

# g$grobs[[grep("guide", g$layout$name)]]

```


### Percent of Students Identified as Economically Disadvantaged by Race and Ethnicity, 2005-2023 

```{r fig.height=8, fig.width=10}
# reading in data
econbyrace <- read.csv("../data/econ_disad_students_Race.csv") %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Unknown - Race/Ethnicity not provided" &
           race != "Native Hawaiian  or Pacific Islander") %>%
  filter(division_name != "Virginia") %>%
  filter(school_year != "2003-2004") %>%  # The total data doesn't include this year
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City"), labels = c("Albemarle", "Charlottesville")),
         race = factor(race, 
                       levels = c("Asian", "Black, not of Hispanic origin", "Hispanic", "Non-Hispanic, two or more races", "White, not of Hispanic origin"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White")),
         plot_year = as.numeric(substr(school_year, 6, 9)),
         label = ifelse((!division_name %in% "Virginia") & (plot_year %in% str_sort_last(plot_year)),
                         paste0(as.character(round(percent, digits = 0)), "%"), NA))

# getting totals 
econtot <- read.csv("../data/economically_disadvantaged_students.csv") %>%
  filter(division_name != "Virginia") %>% 
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City"), labels = c("Albemarle", "Charlottesville")),
         race = "Total",
         plot_year = as.numeric(substr(school_year, 6, 9)))
# Plot 

ggplot() + 
  geom_line(data = econbyrace, aes(x = plot_year, y = percent, color = race), linewidth = 0.8) +
  geom_point(data = econbyrace, aes(x = plot_year, y = percent, color = race)) +
  geom_text_repel(data = econbyrace, aes(x = plot_year, y = percent, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c("#E0004E", "#58a2ee","#860967", "#a942be", "#0cc0aa")) + 
  new_scale_color() +
  geom_line(data = econtot, aes(plot_year, percent, color = race), linewidth = 0.8, linetype = "dashed") +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 100),
                     expand = expansion(mult = c(.03, .02)),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") +
  scale_x_continuous(breaks = seq(from = 2005, to = 2023, by = 1),
                     name = "School Year") +
  theme_minimal() +  
  facet_wrap(~ division_name, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

```

### Percent of Students Identified as Economically Disadvantaged by Race and Ethnicity in 2023

```{r fig.height = 9, fig.width=10}
# reading in data
econbyrace <- read.csv("../data/econ_disad_students_Race.csv") %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Unknown - Race/Ethnicity not provided" &
           race != "Native Hawaiian  or Pacific Islander") %>% 
  rename(Race = race) %>%
  filter(school_year == '2022-2023')

econbyrace$Race <- recode(econbyrace$Race, 
                         "Black, not of Hispanic origin" = "Black",
                         "Non-Hispanic, two or more races" = "Multiracial",
                         "White, not of Hispanic origin" = "White")

econbyrace$division_name <- recode(econbyrace$division_name, 
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville")

econbyrace <- econbyrace %>% 
  mutate(label = paste0(as.character(round(percent, digits = 0)), "%"))

# getting totals 
econtot <- read.csv("../data/economically_disadvantaged_students.csv") %>%
  filter(school_year == '2022-2023') 

econtot$division_name <- recode(econtot$division_name, 
                                   "Albemarle County" = "Albemarle",
                                   "Charlottesville City" = "Charlottesville")

# Plot 
ggplot() + 
  geom_col(data = econbyrace, aes(y = percent, x = division_name, fill = division_name)) + 
  geom_text(data = econbyrace, aes(y = percent, x = division_name, color = division_name, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = econtot, aes(y = percent, x = division_name, color = "% of Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("% of Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "") +
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
```

## People Experiencing Homelessness
```{r fig.height=8, fig.width=10}
# reading in data
homelesssbyrace <- read.csv("../data/pit_homelessness_race.csv") %>%
  filter(group != "aian" & group != "nhpi") %>% 
  mutate(race = factor(group, 
                       levels = c("asian", "black", "hispanic", "multi", "nonhispanic", "white", "total"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "Non-Hispanic", "White", "Rate for Total Population")),
         locality = "Charlottesville Region",
         pt_label = substr(race, 1,1))


plot_homeless_gaps <- ggplot() + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2020.5, ymax = 2021.5), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2018.5, ymax = 2019.5), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2016.5, ymax = 2017.5), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2014.5, ymax = 2015.5), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_point(data = homelesssbyrace, aes(x = rate_region, y = year, group = year, col = race), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 7)) +
  new_scale_color() +
  geom_line(data = homelesssbyrace, aes(x = rate_region, y = year, group = year, color=locality), size = 0.8) +
  geom_point(data = homelesssbyrace, aes(x = rate_region, y = year, group = year, color=locality), position = 'identity', size = 7) +
  scale_color_manual(values = one_category_palette) +
  scale_x_continuous(limits = c(0, 4),
                     expand = expansion(mult = c(.075, .02)),
                     breaks = seq(0, 4, by = 1),
                     name = "Rate per 1000 People",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .02)),
                     breaks = seq(2014, 2022, by = 1),
                     name = "Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(data = homelesssbyrace, aes(x = rate_region, y = year, group = year, col = race, label = pt_label), size = 4) +
  scale_color_manual(values=rep("white",7)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-38)),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top"
        )

g <- ggplotGrob(plot_homeless_gaps)
lbls <- c("A", "B", "H", "M", "N", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

```

### Rate of People Experiencing Homelessness in the Charlottesville Region by Race and Ethnicity, 2014-2022 

```{r fig.height=8, fig.width=10}

homelesssbyrace <- read.csv("../data/pit_homelessness_race.csv") %>%
  filter(group != "aian" & group != "nhpi") %>% 
  mutate(race = factor(group, 
                       levels = c("asian", "black", "hispanic", "multi", "nonhispanic", "white", "total"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "Non-Hispanic", "White", "Rate for Total Population")))

homelesssbyrace <- homelesssbyrace %>% 
  pivot_longer(cols = c('rate_cvlalb', 'rate_region'),
                                  names_to = c('.value','Locality'),
                                  names_pattern = '(.+)_(cvlalb|region)') %>% 
  mutate(Locality = factor(Locality, levels = c("cvlalb", "region"), labels = c("Charlottesville and Albemarle", "Wider Charlottesville Region")))

homelesssbyrace_filter <- homelesssbyrace %>% 
  filter(group != "total") %>% 
  mutate(label = ifelse(year %in% str_sort_last(year),
                         as.character(round(rate, digits = 1)), NA))

homelesssbyrace_total <- homelesssbyrace %>% 
  filter(group == "total")

# Plot 

ggplot() + 
  geom_line(data = homelesssbyrace_filter, aes(x = year, y = rate, color = race), linewidth = 0.8) +
  geom_point(data = homelesssbyrace_filter, aes(x = year, y = rate, color = race)) +
  geom_text_repel(data = homelesssbyrace_filter, aes(x = year, y = rate, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c("#E0004E", "#58a2ee","#860967", "#a942be", "#D3D3D3", "#0cc0aa")) + 
  new_scale_color() +
  geom_line(data = homelesssbyrace_total, aes(x = year, y = rate, color = race), linewidth = 0.8, linetype = "dashed") +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 7),
                     breaks = seq(0, 7, by = 1),
                     name = "Rate per 1000 People",
                     expand = expansion(mult = c(.03, .02))) +
  scale_x_continuous(breaks = seq(from = 2014, to = 2022, by = 1),
                     name = "Year") +
  theme_minimal() +  
  facet_wrap(~ Locality, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

```

### Rate of People Experiencing Homelessness by Race and Ethnicity in 2022

```{r fig.height = 9, fig.width=10}
# reading in data
hombyrace <- read.csv("../data/pit_homelessness_race.csv")  %>%
  filter(year == 2022) %>%
  filter(group != "aian" & group != "nhpi") %>%
  rename(Race = group)

hombyrace$Race <- recode(hombyrace$Race, 
                          "black" = "Black",
                          "nonhispanic" = "Non-Hispanic",
                          "white" = "White",
                          "multi" = "Multiracial",
                          "total" = "Total",
                          "hispanic" = "Hispanic",
                          "asian" = "Asian") 

hombyrace <- pivot_longer(hombyrace, cols = c('rate_cvlalb', 'rate_region'),
                                  names_to = c('.value','Locality'),
                                  names_pattern = '(.+)_(cvlalb|region)') %>% 
  mutate(Locality = factor(Locality, levels = c("cvlalb", "region"), labels = c("Charlottesville & Albemarle", "Wider Charlottesville Region")),
         label = ifelse(year %in% str_sort_last(year),
                         as.character(round(rate, digits = 1)), NA))

# total
homtotal <- hombyrace %>%
  filter(Race == "Total") %>%
  rename(Group = Race)

# by race
hombyrace <- hombyrace %>%
  filter(Race != "Total")

# Plot 
ggplot() + 
  geom_col(data = hombyrace, aes(y = rate, x = Locality, fill = Locality)) + 
  geom_text(data = hombyrace, aes(y = rate, x = Locality, color = Locality, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = homtotal, aes(y = rate, x = Locality, color = "Rate for Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("Rate for Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 8),
                     breaks = seq(0, 8, by = 2),
                     name = "Rate per 1000 People") + 
  scale_x_discrete(name = "") +
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
```


## Low Birth-Weight Infants

``` {r fig.height=9, fig.width=10}
lbw_race <- read.csv("../data/low_birth_weight_race.csv")
lbw_race <- lbw_race %>% filter(group != "other") # can't define, catagory contains unknown/inconsistent variables 

lbw_race <- lbw_race %>% 
  mutate(group = factor(group, levels = c("black", "white", "all"), labels = c("Black", "White", "All")),
         locality = recode(locality, "Albemarle County" = "Albemarle",
                           "Charlottesville City" = "Charlottesville",
                           "Commonwealth Of Virginia" = "Virginia"),
         year_space = ifelse(locality == "Virginia", year - 0.7, 
                       ifelse(locality == "Albemarle", year + 0.7, 
                              year)),
         group = recode(group, "All" = "Total (All Groups)")
         ) %>% 
  filter(year %in% c(2001,2004,2007,2010,2013,2016,2019) ) 

lbw_race <- lbw_race %>% 
  mutate(pt_label = substr(group, 1,1))

plot_LBW <- ggplot(lbw_race, aes(x = percent_3yr, y = year_space, group = year_space)) + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2014.5, ymax = 2017.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2008.5, ymax = 2011.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2002.5, ymax = 2005.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_point(aes(col = group), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 3)) +
  new_scale_color() +
  geom_line(aes(color = locality), size = 0.8) +
  geom_point(aes(color = locality), position = 'identity', size = 7) +
  # geom_label(aes(label = pt_label), fill = NA, color = "white", fontface = "bold") +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 20),
                     expand = expansion(mult = c(.09, .03)),
                     breaks = seq(0, 20, by = 5),
                     labels = label_percent(scale = 1),
                     name = "Percent of Infants",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .03)),
                     breaks = seq(2001, 2019, by = 3),
                     labels = c("2000-02", "2003-05", "2006-08", "2009-11", "2012-14", "2015-17", "2018-20"),
                     name = "Three-Year Period") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(aes(label = pt_label, col = group), size = 4) +
  scale_color_manual(values=rep("white",3)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-52)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        # legend.box = 'horizontal',
        # legend.position = c(0.01, 0.2)
        legend.position = "top"
        )

g <- ggplotGrob(plot_LBW)
lbls <- c("B", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

```

### Percent of Low Birth-Weight Infants by Race, 2000-2020 

```{r fig.height=8, fig.width=10}
# reading in data
lbw_race <- read.csv("../data/low_birth_weight_race.csv")
lbw_race <- lbw_race %>% 
  filter(group != "other") %>%  # can't define, catagory contains unknown/inconsistent variables 
  filter(locality != "Commonwealth Of Virginia")

lbw_race <- lbw_race %>% 
  mutate(race = factor(group, levels = c("black", "white", "all"), labels = c("Black", "White", "All")),
         locality = recode(locality, "Albemarle County" = "Albemarle",
                           "Charlottesville City" = "Charlottesville"),
         race = recode(race, "All" = "Total (All Groups)")) %>% 
  filter(year %in% c(2001,2004,2007,2010,2013,2016,2019) )

lbw_race_only <- lbw_race %>% 
  filter(group != "all") %>% 
  mutate(label = ifelse(year %in% str_sort_last(year),
                         paste0(as.character(round(percent_3yr, digits = 0)), "%"), NA))

lbw_race_total <- lbw_race %>% 
  filter(group == "all")

# Plot 
ggplot() + 
  geom_line(data = lbw_race_only, aes(x = year, y = percent_3yr, color = race), linewidth = 0.8) +
  geom_point(data = lbw_race_only, aes(x = year, y = percent_3yr, color = race)) +
  geom_text_repel(data = lbw_race_only, aes(x = year, y = percent_3yr, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c("#58a2ee", "#0cc0aa")) + 
  new_scale_color() +
  geom_line(data = lbw_race_total, aes(year, percent_3yr, color = race), linewidth = 0.8, linetype = "dashed") +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 30),
                     expand = expansion(mult = c(.03, .02)),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") +
  scale_x_continuous(breaks = seq(2001, 2019, by = 3),
                     labels = c("2000-02", "2003-05", "2006-08", "2009-11", "2012-14", "2015-17", "2018-20"),
                     name = "Three-Year Period") +
  theme_minimal() +  
  facet_wrap(~ locality, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

```

### Percent of Low Birth-Weight Infants by Race for 2018-2020

```{r fig.height = 5, fig.width=10}
# reading in data 
lbw_race <- read.csv("../data/low_birth_weight_race.csv") %>%
  filter(year == 2019) %>%
  filter(group != "other") %>%
  rename(Race = group)

lbw_race$Race <- recode(lbw_race$Race,
                  "black" = "Black",
                  "white" = "White")
                  
lbw_race$locality <- recode(lbw_race$locality, 
                      "Albemarle County" = "Albemarle",
                      "Charlottesville City" = "Charlottesville",
                      "Commonwealth Of Virginia" = "Virginia")

# by race
lbw_race_only <- lbw_race %>%
  filter(Race != "all")

lbw_race_only <- lbw_race_only %>% 
  mutate(label = paste0(as.character(round(percent_3yr, digits = 0)), "%"))
                      
# totals 
lbw_race_total <- lbw_race %>%
  filter(Race == "all") %>%
  select(-Race)

# Plot 
ggplot() + 
  geom_col(data = lbw_race_only, aes(y = percent_3yr, x = locality, fill = locality)) + 
  geom_text(data = lbw_race_only, aes(y = percent_3yr, x = locality, color = locality, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = lbw_race_total, aes(y = percent_3yr, x = locality, color = "% of Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("% of Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 30),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") + 
  scale_x_discrete(name = "") +
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
```

## Infant Deaths

``` {r fig.height=9, fig.width=10}
infant_mortality_race <- read.csv("../data/infant_mortality_race.csv")
infant_mortality_race <- infant_mortality_race %>% filter(group != "other") # can't define, catagory contains unknown/inconsistent variables 

infant_mortality_race <- infant_mortality_race %>% 
  mutate(group = factor(group, levels = c("black", "white", "all"), labels = c("Black", "White", "All")),
         locality = recode(locality, "Albemarle County" = "Albemarle",
                           "Charlottesville City" = "Charlottesville",
                           "Commonwealth Of Virginia" = "Virginia"),
         year_space = ifelse(locality == "Virginia", year - 0.7, 
                       ifelse(locality == "Albemarle", year + 0.7, 
                              year)),
         group = recode(group, "All" = "Total (All Groups)")
         ) %>% 
  filter(year %in% c(2001,2004,2007,2010,2013,2016,2019)) 


infant_mortality_race <- infant_mortality_race %>% 
  mutate(pt_label = substr(group, 1,1))

plot_IM <- ggplot(infant_mortality_race, aes(x = rate_3yr, y = year_space, group = year_space)) + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2014.5, ymax = 2017.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2008.5, ymax = 2011.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2002.5, ymax = 2005.5), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_point(aes(col = group), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 3)) +
  new_scale_color() +
  geom_line(aes(color = locality), size = 0.8) +
  geom_point(aes(color = locality), position = 'identity', size = 7) +
  # geom_label(aes(label = pt_label), fill = NA, color = "white", fontface = "bold") +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 25),
                     expand = expansion(mult = c(.09, .03)),
                     breaks = seq(0, 25, by = 5),
                     labels = label_percent(scale = 1),
                     name = "Percent of Infants",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .03)),
                     breaks = seq(2001, 2019, by = 3),
                     labels = c("2000-02", "2003-05", "2006-08", "2009-11", "2012-14", "2015-17", "2018-20"),
                     name = "Three-Year Period") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(aes(label = pt_label, col = group), size = 4) +
  scale_color_manual(values=rep("white",3)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-52)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        # legend.box = 'horizontal',
        # legend.position = c(0.01, 0.2)
        legend.position = "top"
        )

g <- ggplotGrob(plot_IM)
lbls <- c("B", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

```

### Percent of Infant Deaths by Race, 2000-2020 

```{r fig.height=8, fig.width=10}
# reading in data
infant_mortality_race <- read.csv("../data/infant_mortality_race.csv")
infant_mortality_race <- infant_mortality_race %>% 
  filter(group != "other") %>%  # can't define, catagory contains unknown/inconsistent variables
  filter(locality != "Commonwealth Of Virginia")

infant_mortality_race <- infant_mortality_race %>% 
  mutate(race = factor(group, levels = c("black", "white", "all"), labels = c("Black", "White", "All")),
         locality = recode(locality, "Albemarle County" = "Albemarle",
                           "Charlottesville City" = "Charlottesville"),
         race = recode(race, "All" = "Total (All Groups)")) %>% 
  filter(year %in% c(2001,2004,2007,2010,2013,2016,2019) )

im_race_only <- infant_mortality_race %>% 
  filter(group != "all") %>% 
  mutate(label = ifelse(year %in% str_sort_last(year),
                         paste0(as.character(round(rate_3yr, digits = 0)), "%"), NA))

im_total <- infant_mortality_race %>% 
  filter(group == "all")

# Plot 
ggplot() + 
  geom_line(data = im_race_only, aes(x = year, y = rate_3yr, color = race), linewidth = 0.8) +
  geom_point(data = im_race_only, aes(x = year, y = rate_3yr, color = race)) +
  geom_text_repel(data = im_race_only, aes(x = year, y = rate_3yr, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c("#58a2ee", "#0cc0aa")) + 
  new_scale_color() +
  geom_line(data = im_total, aes(year, rate_3yr, color = race), linewidth = 0.8, linetype = "dashed") +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 30),
                     expand = expansion(mult = c(.03, .02)),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") +
  scale_x_continuous(breaks = seq(2001, 2019, by = 3),
                     labels = c("2000-02", "2003-05", "2006-08", "2009-11", "2012-14", "2015-17", "2018-20"),
                     name = "Three-Year Period") +
  theme_minimal() +  
  facet_wrap(~ locality, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

```

### Percent of Infant Deaths by Race for 2018-2020

```{r fig.height = 5, fig.width=10}
# reading in data 
id <- read.csv("../data/infant_mortality_race.csv")%>%
  filter(year == 2019) %>%
  filter(group != "other") %>%
  rename(Race = group)

id$Race <- recode(id$Race,
                  "black" = "Black",
                  "white" = "White")
                  
id$locality <- recode(id$locality, 
                      "Albemarle County" = "Albemarle",
                      "Charlottesville City" = "Charlottesville",
                      "Commonwealth Of Virginia" = "Virginia")

# by race
idrace <- id %>%
  filter(Race != "all") %>% 
  mutate(label = paste0(as.character(round(rate_3yr, digits = 0)), "%"))

# totals 
idtot <- id %>%
  filter(Race == "all") %>%
  select(-Race)

# Plot 
ggplot() + 
  geom_col(data = idrace, aes(y = rate_3yr, x = locality, fill = locality)) + 
  geom_text(data = idrace, aes(y = rate_3yr, x = locality, color = locality, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = idtot, aes(y = rate_3yr, x = locality, color = "% of Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("% of Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 30),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") + 
  scale_x_discrete(name = "") +
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
# Charlottesville really does have 0 for Black and Other race, it's not missing 

```

## Special Education Services

```{r fig.height=14, fig.width=10}
#for all sped visualizations
sped_race_dat <- read.csv("../data/sped_services_by_race.csv") %>%
  mutate(total_sped = as.numeric(sub(",", "", total_sped, fixed = TRUE)),
         total_count = as.numeric(sub(",", "", total_count, fixed = TRUE)),
         percent_sped = round(total_sped / total_count * 100, 2))

# reading in data
sped_services_race <- sped_race_dat %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Native Hawaiian  or Pacific Islander") %>%
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City", "Virginia"), labels = c("Albemarle", "Charlottesville", "Virginia")),
         # total_sped = as.numeric(sub(",", "", total_sped, fixed = TRUE)),
         # total_count = as.numeric(sub(",", "", total_count, fixed = TRUE)),
         # percent_sped = round(total_sped / total_count * 100, 2),
         plot_year = as.numeric(substr(school_year, 6, 9))) %>% 
  select(c(school_year, division_name, race, total_sped, percent_sped, plot_year))


# getting totals 
sped_services_tot <- read.csv("../data/sped_services.csv") %>% 
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City", "Virginia"), labels = c("Albemarle", "Charlottesville", "Virginia")),
         race = "Total",
         plot_year = as.numeric(substr(school_year, 6, 9))) %>% 
  select(c(school_year, division_name, race, total_sped, percent_sped, plot_year))

sped_services_alldat <- rbind(sped_services_race, sped_services_tot)

sped_services_alldat <- sped_services_alldat %>% 
  mutate(race = factor(race, 
                       levels = c("Asian", "Black, not of Hispanic origin", "Hispanic", "Non-Hispanic, two or more races", "White, not of Hispanic origin", "Total"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total")),
         year_space = ifelse(division_name == "Virginia", plot_year - 0.3, 
                       ifelse(division_name == "Albemarle", plot_year + 0.3, 
                              plot_year)))


sped_services_alldat <- sped_services_alldat %>% 
  mutate(pt_label = substr(race, 1,1)) %>%
  filter(plot_year >= 2013) # first year in data with both totals and all races

plot_sped_gaps <- ggplot() + 
  #   geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2020, ymax = 2022), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2016, ymax = 2018), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  # geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2012, ymax = 2014), alpha = 0.35, color = NA, fill = "#D3D3D3") +
  geom_point(data = sped_services_alldat, aes(x = percent_sped, y = year_space, group = year_space, col = race), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 6)) +
  new_scale_color() +
  geom_line(data = sped_services_alldat, aes(x = percent_sped, y = year_space, group = year_space, color = division_name), size = 0.8) +
  geom_point(data = sped_services_alldat, aes(x = percent_sped, y = year_space, group = year_space, color = division_name), position = 'identity', size = 7) +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 25),
                     expand = expansion(mult = c(.075, .02)),
                     breaks = seq(0, 25, by = 5),
                     labels = label_percent(scale = 1),
                     name = "Percent of Students",
                     sec.axis = dup_axis()) +
  scale_y_continuous(expand = expansion(mult = c(.03, .02)),
                     breaks = seq(2010, 2023, by = 1),
                     name = "School Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(data = sped_services_alldat, aes(x = percent_sped, y = year_space, group = year_space, label = pt_label, col = race), size = 4) +
  scale_color_manual(values=rep("white",6)) +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-38)),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top"
        )

g <- ggplotGrob(plot_sped_gaps)
lbls <- c("A", "B", "H", "M", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

```

### Percent of Students Recieving Special Education Services by Race and Ethnicity, 2013-2022 

```{r fig.height=8, fig.width=10}
# reading in data
sped_services_race <- sped_race_dat %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Native Hawaiian  or Pacific Islander") %>%
  filter(division_name != "Virginia") %>%
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City"), labels = c("Albemarle", "Charlottesville")),
         race = factor(race, 
                       levels = c("Asian", "Black, not of Hispanic origin", "Hispanic", "Non-Hispanic, two or more races", "White, not of Hispanic origin"),
                       labels = c("Asian", "Black", "Hispanic", "Multiracial", "White")),
         plot_year = as.numeric(substr(school_year, 6, 9)),
         label = ifelse((plot_year %in% str_sort_last(plot_year)),
                         paste0(as.character(round(percent_sped, digits = 0)), "%"), NA)) %>% 
  filter(plot_year >= 2013)


# getting totals 
sped_services_tot <- read.csv("../data/sped_services.csv") %>% 
  filter(division_name != "Virginia") %>%
  mutate(division_name = factor(division_name, levels = c("Albemarle County", "Charlottesville City"), labels = c("Albemarle", "Charlottesville")),
         race = "Total",
         plot_year = as.numeric(substr(school_year, 6, 9))) %>% 
  filter(plot_year >= 2013)

# Plot 

ggplot() + 
  geom_line(data = sped_services_race, aes(x = plot_year, y = percent_sped, color = race), linewidth = 0.8) +
  geom_point(data = sped_services_race, aes(x = plot_year, y = percent_sped, color = race)) +
  geom_text_repel(data = sped_services_race, aes(x = plot_year, y = percent_sped, color = race, label = label), size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = c("#E0004E", "#58a2ee","#860967", "#a942be", "#0cc0aa")) + 
  new_scale_color() +
  geom_line(data = sped_services_tot, aes(plot_year, percent_sped, color = race), linewidth = 0.8, linetype = "dashed") +
  scale_color_manual(values = c("#5C6068")) +
  scale_y_continuous(limits = c(0, 30),
                     breaks = seq(0, 30, by = 5),
                     expand = expansion(mult = c(.03, .02)),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") +
  scale_x_continuous(breaks = seq(from = 2013, to = 2022, by = 1),
                     name = "School Year") +
  theme_minimal() +  
  facet_wrap(~ division_name, ncol = 2, scales='free_y') +
  theme(text = element_text(size = 14),
        panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.text.y = element_text(margin = margin(r=-8)),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        axis.title.y.right = element_text(margin = margin(l=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top") +
  labs(color = "")

```

### Percent of Students Recieving Special Education Services by Race and Ethnicity for the 2021-2022 School Year

```{r fig.height = 9, fig.width=10}
# reading in data
sped_services_race <- sped_race_dat %>%
  filter(race != "American Indian or Alaska Native" & 
           race != "Native Hawaiian  or Pacific Islander") %>% 
  rename(Race = race) %>%
  filter(school_year == '2021-2022')

sped_services_race$Race <- recode(sped_services_race$Race, 
                         "Black, not of Hispanic origin" = "Black",
                         "Non-Hispanic, two or more races" = "Multiracial",
                         "White, not of Hispanic origin" = "White")

sped_services_race$division_name <- recode(sped_services_race$division_name, 
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville")

sped_services_race <- sped_services_race %>% 
  mutate(label = paste0(as.character(round(percent_sped, digits = 0)), "%"))

# getting totals 
sped_services_tot <- read.csv("../data/sped_services.csv") %>%
  filter(school_year == '2021-2022') 

sped_services_tot$division_name <- recode(sped_services_tot$division_name, 
                                   "Albemarle County" = "Albemarle",
                                   "Charlottesville City" = "Charlottesville")

# Plot 
ggplot() + 
  geom_col(data = sped_services_race, aes(y = percent_sped, x = division_name, fill = division_name)) + 
  geom_text(data = sped_services_race, aes(y = percent_sped, x = division_name, color = division_name, label = label), 
                  size = 4, 
                  vjust = -0.5,
                  hjust = -0.85,
                  fontface = "bold",
            show.legend = FALSE) +
  scale_color_manual(values = three_category_palette) +
  scale_fill_manual(values = three_category_palette) +
  new_scale_color() +
  geom_point(data = sped_services_tot, aes(y = percent_sped, x = division_name, color = "% of Whole Population"), size = 4) + 
  scale_color_manual("",
                     breaks = c("% of Whole Population"),
                     values = c("#2F3136")) +
  scale_y_continuous(limits = c(0, 30),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "") +
  facet_wrap(~ Race, ncol = 2, scales='free_x') +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        strip.text.x = element_text(size = 16),
        panel.spacing = unit(1, "lines"),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13),
        axis.title.y = element_text(margin = margin(r=8)),
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.text = element_text(size = 12),
        legend.position = "top") +
  labs(fill = "")
```

## Out-of-School Suspensions (no threshold filter)

```{r fig.height=7.4, fig.width=10}

library(stats)
library(ggpubr)
library(plotrix)

# reading in data
nonprekVAall <- read.csv("../data/school_suspension_CRDCnonprek.csv")
nonprekVAall$OSS_Total <- rowSums(nonprekVAall[,c('OSS_Black','OSS_Hispanic','OSS_White','OSS_TwoOrMore', 'OSS_Asian')], na.rm = T)
nonprekVAall$totalstudents <- nonprekVAall$num_Total
nonprekVAall <- nonprekVAall %>%
  filter(Year != 2009)

## Re-shaping them to long format 
k12long_count_oss <- pivot_longer(nonprekVAall, cols = c('num_Black', 'num_Hispanic', 'num_White',
                                                         'num_TwoOrMore', 'num_Asian', 'num_Total',
                                                         'OSS_Black', 'OSS_Hispanic', 'OSS_White',
                                                         'OSS_TwoOrMore','OSS_Asian', 'OSS_Total'),
                                  names_to = c('.value','Race'),
                                  names_pattern = '(.+)_(Black|White|Hispanic|Asian|TwoOrMore|Total)')

k12long_count_oss$Race <- ifelse(k12long_count_oss$Race == "TwoOrMore", "Multiracial", k12long_count_oss$Race)

# Calculating the percent of students suspended in each racial group 
k12long_count_oss$percsus <- round(k12long_count_oss$OSS / k12long_count_oss$num * 100, 2)
# Calculating the percent of the students enrolled in each racial group 
k12long_count_oss$percenroll <- round(k12long_count_oss$num / k12long_count_oss$totalstudents * 100, 2)
# Calculating means by race and year for plotting 
k12OSSmeans <- k12long_count_oss %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(k12OSSmeans$Year), totalsus = k12OSSmeans$meanpercsus[k12OSSmeans$Race == "Total"])
k12OSSmeans <- merge(k12OSSmeans, totalsusovertime, by = 'Year')
# k12OSSmeans$lessthan <- ifelse(k12OSSmeans$meanenroll < (100 / k12OSSmeans$totalsus), TRUE, FALSE)
# k12OSSmeans <- k12OSSmeans %>%
#   filter(lessthan == FALSE)
k12OSSmeans$Locality <- "Virginia"

# Charlottesville = CHARLOTTESVILLE CTY PBLC SCHS
# Albemarle = ALBEMARLE CO PBLC SCHS
albk12 <- k12long_count_oss %>%
  filter(LEA == "ALBEMARLE CO PBLC SCHS")
cvillek12 <- k12long_count_oss %>%
  filter(LEA == "CHARLOTTESVILLE CTY PBLC SCHS")

# Albemarle
# Calculating means by race and year for plotting 
albk12OSSmeans <- albk12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))
# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(albk12OSSmeans$Year), totalsus = albk12OSSmeans$meanpercsus[albk12OSSmeans$Race == "Total"])
albk12OSSmeans <- merge(albk12OSSmeans, totalsusovertime, by = 'Year')
# albk12OSSmeans$lessthan <- ifelse(albk12OSSmeans$meanenroll < (100 / albk12OSSmeans$totalsus), TRUE, FALSE)
# albk12OSSmeans <- albk12OSSmeans %>%
#   filter(lessthan == FALSE)
albk12OSSmeans$Locality <- "Albemarle"

# Cville
cvillek12OSSmeans <- cvillek12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))
# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(cvillek12OSSmeans$Year), totalsus = cvillek12OSSmeans$meanpercsus[cvillek12OSSmeans$Race == "Total"])
cvillek12OSSmeans <- merge(cvillek12OSSmeans, totalsusovertime, by = 'Year')
# cvillek12OSSmeans$lessthan <- ifelse(cvillek12OSSmeans$meanenroll < (100 / cvillek12OSSmeans$totalsus), TRUE, FALSE)
# cvillek12OSSmeans <- cvillek12OSSmeans %>%
#   filter(lessthan == FALSE)
cvillek12OSSmeans$Locality <- "Charlottesville"

dat <- rbind(k12OSSmeans, albk12OSSmeans, cvillek12OSSmeans)

dat_OSS <- dat
dat_OSS$Year <- ifelse(dat_OSS$Locality == "Virginia", dat_OSS$Year - 0.5, 
                       ifelse(dat_OSS$Locality == "Albemarle", dat_OSS$Year + 0.5, dat_OSS$Year))

### Plots  adjust shape and color
## years are fall year, create school year +1
# all levels together 

dat_OSS <- dat_OSS %>% 
  mutate(Race = factor(Race, levels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total"), labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total")),
       pt_label = substr(Race, 1,1))

plot_OSS <- ggplot(dat_OSS, aes(x = meanpercsus, y = Year, group = Year)) + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2016, ymax = 2018), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2012, ymax = 2014), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_point(aes(col = Race), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 6)) +
  new_scale_color() +
  geom_line(aes(color = Locality), size = 0.8) +
  geom_point(aes(color = Locality), position = 'identity', size = 7) +
  # geom_label(aes(label = pt_label), fill = NA, color = "white", fontface = "bold") +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(0, 15),
                     expand = expansion(mult = c(.11, .03)),
                     breaks = seq(0, 15, by = 5),
                     labels = label_percent(scale = 1),
                     name = "Average Percent of Students Receiving OSS",
                     sec.axis = dup_axis()) +
  scale_y_continuous(breaks = seq(2011, 2017, by = 2),
                     expand = expansion(mult = c(.03, .03)),
                     labels = c("2011-12", "2013-14", "2015-16", "2017-18"),
                     name = "School Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(aes(label = pt_label, col = Race), size = 4) +
  scale_color_manual(values=rep("white",6)) +
#   labs(caption = "Note: Racial groups were only included for a given year and locality when the average number of students enrolled was high enough
# such that you would expect to see at least one suspension if the average overall rate were true for each racial group") +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-54)),
        # axis.text.x = element_text(size = 13),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        # legend.box = 'horizontal',
        # legend.position = c(0.01, 0.2)
        legend.position = "top"
        )

g <- ggplotGrob(plot_OSS)
lbls <- c("A", "B", "H", "M", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)

# g$grobs[[grep("guide", g$layout$name)]]


```

## Post-Secondary Education (no threshold filter)

### Enrollment in Any Post-Secondary Education
```{r fig.height=9, fig.width=10}

dat <- read.csv("../data/postsecondary_education_race.csv")

# We have 9 racial categories
# I'm filtering out a couple for now
# NOTE - There are only values for "American Indian" for the state overall, not in the county or city
# I'm adding it here for mow
dat <- dat %>%
  filter(group != "Race Unknown") %>% # No values in Charlottesville or Albermarle
  filter(group != "Native Hawaiian") %>% # No values in Charlottesville or Albemarle
  filter(group != "American Indian") # No values in Charlottesville or Albemarle

# ..................................................
# Need to calculate the overall averages for each year to show in plot 
# NOTE - What is the difference between these totals and "All Students", the values are not the same
totals <- dat %>%
  group_by(year, locality) %>%
  summarise(cohortsize = sum(cohortsize, na.rm = T),
            enrolledany = sum(enrolledany, na.rm = T),
            enrolled4yr = sum(enrolled4yr, na.rm = T)) %>%
  mutate(percent_any = round(enrolledany / cohortsize * 100, 2),
         percent_4yr = round(enrolled4yr / cohortsize * 100, 2))

totals$group <- "Total"

plotdat <- rbind(dat, totals)
plotdat <- plotdat %>% 
  filter(year %in% c(2008,2010,2012,2014,2016,2018,2020)) # reduce to odd years only

plotdat$group <- ifelse(plotdat$group == "2 or More", "Multiracial", plotdat$group)

plotdat$year <- ifelse(plotdat$locality == "Virginia", plotdat$year - 0.5, 
                       ifelse(plotdat$locality == "Albemarle", plotdat$year + 0.5, plotdat$year))

# ..................................................
# Creating plots

#### Any enrollment

# Filtering for racial groups whose group is large enough that we would expect at least one 
# student to enroll in 4-year college if total rate were equal across racial groups 
totalstimeAny <- data.frame(year = unique(plotdat$year), totalenrollperc = plotdat$percent_any[plotdat$group == "Total"])
plotdatAny <- merge(plotdat, totalstimeAny, by = 'year')
# plotdatAny$lessthan <- ifelse(plotdatAny$cohortsize < (100 / plotdatAny$enrolled4yr), TRUE, FALSE)
# plotdatAny <- plotdatAny %>%
#   filter(lessthan == FALSE)

plotdatAny <- plotdatAny %>%
  filter(group != "Total")

# plotdatAny <- rbind(plotdatAny, blanks)

# Rename "All Students" to "Total" but idk if this is accurate per above
plotdatAny$group <- ifelse(plotdatAny$group == "All Students", "Total", plotdatAny$group)
plotdatAny <- plotdatAny %>% 
   mutate(group = factor(group, levels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total"), labels = c("Asian", "Black", "Hispanic", "Multiracial", "White", "Total")),
       pt_label = substr(group, 1,1))

plot_PSE <- ggplot(plotdatAny, aes(x = percent_any, y = year, group = year)) + 
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2017, ymax = 2019), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2013, ymax = 2015), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 2009, ymax = 2011), alpha = .05, color = NA, fill = "#f5f5f5") +
  geom_point(aes(col = group), position = 'identity', size = 7) +
  scale_color_manual(values=rep("#5C6068", 6)) +
  new_scale_color() +
  geom_line(aes(color = locality), size = 0.8) +
  geom_point(aes(color = locality), position = 'identity', size = 7) +
  # geom_label(aes(label = pt_label), fill = NA, color = "white", fontface = "bold") +
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(limits = c(40,100),
                     breaks = seq(40, 100, by = 10),
                     expand = expansion(mult = c(.06, .02)),
                     labels = label_percent(scale = 1),
                     name = "Percent of Students",
                     sec.axis = dup_axis()) +
  scale_y_continuous(breaks = seq(2008, 2020, by = 2),
                     expand = expansion(mult = c(.03, .03)),
                     # labels = c("2011-12", "2013-14", "2015-16", "2017-18"),
                     name = "Year") + 
  theme_minimal() +
  new_scale_color() +
  geom_text(aes(label = pt_label, col = group), size = 4) +
  scale_color_manual(values=rep("white",6)) +
#   labs(caption = "Note: Racial groups were only included for a given year and locality when the number of students enrolled was high enough such 
# that you would expect to see at least one student enrolled in a 4-year institution if the overall rate were true for each racial group") +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        text = element_text(size = 14),
        axis.text = element_text(size = 13),
        axis.text.y = element_text(margin = margin(r=-38)),
        axis.title = element_text(size = 14),
        axis.title.y = element_text(margin = margin(r=10)),
        axis.title.x = element_text(margin = margin(t=12)),
        # axis.title.x.bottom = element_blank(),
        axis.title.x.top = element_text(margin = margin(b=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)),
        legend.title=element_blank(),
        legend.position = "top"
        )

g <- ggplotGrob(plot_PSE)
lbls <- c("A", "B", "H", "M", "W", "T")
idx <- which(sapply(g$grobs[[15]][[1]][[2]]$grobs,function(i){
  "label" %in% names(i)}))
for(i in 1:length(idx)){
g$grobs[[15]][[1]][[2]]$grobs[[idx[i]]]$label <- lbls[i]
}
grid.draw(g)
```