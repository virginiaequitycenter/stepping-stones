---
title: "DRAFT - Stepping Stones Report"
author: "Michele Claibourn, Elizabeth Mitchell, Nina Schoonover, Lee LeBoeuf"
date: "DRAFT DATE: 5/8/2023"
output:
  # pdf_document:
  html_document:
    # template: school-composition-template.html
    # theme:
    #   base_font:
    #     google: "Poppins"
    #   heading_font:
    #     google: "Oswald"
    #   # bootswatch: spacelab
    #   version: 5
    # css: styles.css
    toc: true
    toc_depth: 3
    # toc_float: true
# toc-title: Contents
---
```{css, echo=FALSE}
h1, h2, h3, h4, h5, h6 {
  padding-top: 1rem;
}
div.section.level4.tabset h4 {
  font-size: 24px;
}
h5, h6 {
  font-size: 18px;
  max-width: 850px;
}

div#TOC ul {
  list-style-type: none;
  font-size: 18px;
}

div#TOC ul li ul {
  list-style-type: circle;
}

div#TOC ul li a {
  color: #000000;
}

.main-container {
  max-width: 86vw;
  margin-left: auto;
  margin-right: auto;
}
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8.5, fig.height = 5)

library(tidyverse)
library(scales)
library(janitor)
library(ggthemes)
library(ggrepel)
library(bslib)
library(stringr)

str_sort_last <- function(object){
  last <- str_sort(object)
  last <- tail(last, 1)
  last
}

three_category_palette <- c("#E57873", "#146A94", "#58C9AB")
two_category_palette <- c("#782C6A", "#58C9AB")
one_category_palette <- c("#782C6A")

# web colors
# three_category_palette <- c("#E48073", "#2F7E9F", "#83DBD7")
# two_category_palette <- c("#782C6A", "#83DBD7")
# one_category_palette <- c("#782C6A")

# black/white/grayscale friendly
# three_category_palette <- c("#E57873", "#0D6A82", "#ADE9ED")
# two_category_palette <- c("#782C6A", "#ADE9ED")
# one_category_palette <- c("#782C6A")

# favs <- c("#E57873", "#2F7E9F", "#83DBD7")
# muted_palette <- c("#96595A", "#DA897C", "#E4E4B2", "#B2E4CF", "#0D6A82")
# 
# test3 <- c("#003f5c", "#7a5195", "#ef5675", "#ffa600")
# test2 <- c("#E57873", "#2F7E9F","#FFD05B", "#EA7000", "#AF0000", "#BDBF00", "#00878F", "#2bd7e3", "#82BAFF", "#ADE9ED")
# 
# test <- c("#EE1C25", "#DD4765", "#6D968A", "#58C9AB", "#D1C627")
# old <- c("#B23B6B", "#5AB48A", "#E7A342")
# two_old <- c("#146A94", "#E7A342")
# one_old <- c("#146A94")


```

## Introduction

### Approach

### Our Youth

### Contributions

## Education and Civic Engagement

### Kindergarteners At or Above Reading Levels {.tabset}

#### Trends

##### Percent of Incoming Kindergarteners At or Above PALS benchmarks for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools

```{r}
pals_kinder <- read_csv("../data/pals_kindergarten_updated.csv")
pals_kinder <- pals_kinder %>% 
  mutate(pct_invert = 100-percent,
         school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!location %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(pct_invert, digits = 0)), "%"), NA))

pals_kinder %>%
  ggplot(aes(x = school_year, y = pct_invert, color = location, group = location)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Incoming Kindergarteners") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")

```

Source: Annie E. Casey Foundation, Kids Count Data Center, "Fall PALS-K [before](https://datacenter.kidscount.org/data/tables/3254-fall-pals-k-before-2015-16) and [after](https://datacenter.kidscount.org/data/tables/10181-fall-pals-k-after-2015-16) 2015/16 in Virginia"

#### About


### Standards of Learning

#### Math: Grades 3, 5, and 8 {.tabset}

##### Trends
###### Percent of Students who Pass the 3rd Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Read in data
sols <- read_csv("../data/sol_pass.csv")
sols <- sols %>% 
  mutate(division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division_name %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(pass_rate, digits = 0)), "%"), NA))

miss2021 <- data.frame(division_name = c("Albemarle", "Charlottesville", "Virginia"),
                       school_year = c("2019-20", "2019-20", "2019-20"))

# Grade 3 Plot
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 3") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-12", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
  
```

Source: Virginia Department of Education (VDOE). 2006 - 2021. https://p1pe.doe.virginia.gov/buildatable/testresults
       
###### Percent of Students who Pass the 5th Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 5") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-12", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

###### Percent of Students who Pass the 8th Grade Math SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sols %>% 
  filter(subject == "Mathematics" & test_level == "Grade 8") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2011-12", linetype = 2, color = "#333333") +
  annotate("text", x = 7.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised math standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### About

#### Reading: Grades 3, 5, and 8 {.tabset}

##### Trends
###### Percent of Students who Pass the 3rd Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Grade 3 Reading Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 3") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-13", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

###### Percent of Students who Pass the 5th Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Grade 5 Reading Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 5") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-13", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

###### Percent of Students who Pass the 8th Grade Reading SOL Test for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
# Grade 8 Plot
sols %>% 
  filter(subject == "English:Reading" & test_level == "Grade 8") %>% 
                        bind_rows(miss2021) %>%
  ggplot(aes(x = school_year, y = pass_rate, 
                 color = division_name, group = division_name)) +
  geom_vline(xintercept = "2019-20", linetype = 2, color = "#333333") +
  annotate("text", x = 15.2, y = 95, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"SOLs not conducted
in 2020 due to the 
COVID-19 Pandemic") +
  geom_vline(xintercept = "2012-13", linetype = 2, color = "#333333") +
  annotate("text", x = 8.2, y = 25, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Implementation of 
revised reading standards") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students Taking SOL") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### About

### Students Eligible for Special Education Services {.tabset}

#### Trends
##### Percent of Students Identified to Receive Special Services for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
sped_services <- read_csv("../data/sped_services.csv")
sped_services <- sped_services %>% 
  mutate(division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division_name %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(percent_sped, digits = 0)), "%"), NA))

sped_services %>% 
  ggplot(aes(x = school_year, y = percent_sped, 
             color = division_name, group = division_name)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Enrolled Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### English Learners {.tabset}

#### Trends
##### Percent of Students Identified as English Learners for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
english_language_learners <- read_csv("../data/english_language_learners.csv")
english_language_learners <- english_language_learners %>%
  mutate(school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!locality %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(pct_english_learners, digits = 0)), "%"), NA))

english_language_learners %>% 
  ggplot(aes(x = school_year, y = pct_english_learners, color = locality, group=locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.2, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Enrolled Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Average Daily Attendance {.tabset}

#### Trends
##### Percent of Students in Attendance on an Average Day for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
average_daily_attendance <- read_csv("../data/average_daily_attendance.csv")
average_daily_attendance <- average_daily_attendance %>% 
  mutate(school_year = paste0(as.character(year-1), "-", as.character(year)),
         school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!name %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(pct_att_total, digits = 0)), "%"), NA))

average_daily_attendance %>%
  ggplot(aes(x = school_year, y = pct_att_total, color = name, group = name)) +
  geom_rect(aes(xmin = "2019-20", xmax = "2020-21", ymin = -Inf, ymax = Inf), alpha = .05, color = NA, fill = "#f5f5f5") +
  annotate("text", x = 10.2, y = 65, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"School schedules 
impacted by 
COVID-19 Pandemic") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(50, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "", fill = "")
```

### On-Time Graduation Rates {.tabset}

#### Trends
##### Percent of Student Cohort Graduating in Four Years for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
graduation_rates <- read_csv("../data/graduation_rates.csv")
graduation_rates <- graduation_rates %>% 
  mutate(school_year = as.character(cohort_year),
         division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         label = ifelse((!division_name %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(graduation_rate, digits = 0)), "%"), NA))

graduation_rates %>%
  ggplot(aes(x = school_year, y = graduation_rate, color = division_name, group = division_name)) +
  # geom_vline(xintercept = "2013", linetype = 2, color = "#333333") +
#   annotate("text", x = 6.2, y = 55, size = 3.5, hjust = 0, color = "#333333", 
#            label = 
# "Charlottesville City Schools
# extend WALK program hours") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Student Cohort") + 
  scale_x_discrete(name = "Graduation Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### Post-Secondary Enrollment {.tabset}

#### Trends
##### Percent of Graduating Students Enrolled in a Post-Secondary Institution within 16 months of High School Graduation for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
postsecondary_education <- read_csv("../data/postsecondary_education.csv")

# pivot to stack 2 year and 4 year
df_long <- postsecondary_education %>% 
  mutate(enrolled4yr = enrolled4pub + enrolled4priv) %>% 
  select(year, locality, cohortsize, enrolled4yr, enrolled2yr, enrolledany) %>% 
  pivot_longer(cols = starts_with("enrolled"), names_to = "type", values_to = "number") %>% 
  mutate(percent = (number/cohortsize)*100,
         school_year = as.character(year))

df_long <- df_long %>% 
  filter(type != "enrolled2yr") %>% 
  mutate(type = recode(type,
                          "enrolled4yr" = "4-Yr Institution",
                          "enrolledany" = "Any Institution"),
         label = ifelse((!locality %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(percent, digits = 0)), "%"), NA))

# keep only 4yr and any - or - 2yr and 4yr

df_long %>%
  ggplot(aes(x = school_year, y = percent, 
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(2,1)) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1),
                     name = "Percent of Graduating Students") +
  scale_x_discrete(name = "Graduation Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "", linetype = "")
```

### High School Degree Attainment {.tabset}

#### Trends
##### Percent of Residents Age 25 and Older with a High School Degree or Equivalent in Albemarle County, City of Charlottesville, and Virginia
```{r}
hsdegree_attainment <- read_csv("../data/hsdegree_attainment.csv")
hsdegree_attainment <- hsdegree_attainment %>% 
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year)),
         label = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round(pcthshigherE, digits = 0)), "%"), NA))

hsdegree_attainment %>%
  ggplot(aes(x = survey_period, y = pcthshigherE, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(40, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Residents") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Registered Voters {.tabset}

#### Trends
##### Percent of Adults (18+) Registered to Vote in Albemarle County, City of Charlottesville, and Virginia
```{r}
voter_reg <- read_csv("../data/vote_reg.csv")
voter_reg <- voter_reg %>% 
  # filter(year != 2021) %>% 
  mutate(year = as.character(year),
         locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         paste0(as.character(round((reg_rate*100), digits = 0)), "%"), NA))

voter_reg %>%
  ggplot(aes(x = year, y = reg_rate, color = locality, group = locality)) +
  geom_vline(xintercept = "2000", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2004", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2008", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2012", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2016", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2020", linetype = 2, color = "#333333") +
  annotate("text", x = 5.2, y = .3, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Presidential
Elections") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.4, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  # scale_x_continuous("Year", labels = as.character(year), breaks = year) + 
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent,
                     name = "Percent of Adults") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

## Economic Security and Housing

### Income Per Capita {.tabset}

#### Trends
##### Income Per Capita for Charlottesville and Albemarle Combined and Virginia
```{r}
per_cap_income <- read_csv("../data/per_cap_income.csv")
per_cap_income <- per_cap_income %>% 
  pivot_longer(cols = c("pci", "adj_pci"), names_to = "type", values_to = "number") %>%
  mutate(year = as.character(year),
         locality = recode(GeoName,
                           "Albemarle + Charlottesville, VA*" = "Albemarle + Charlottesville"),
         type = recode(type,
                       "pci" = "Raw Income",
                       "adj_pci" = "Inflation-Adjusted Income"),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         paste0(as.character(formatC(number, format="d", big.mark=","))), NA))

per_cap_income %>%
  ggplot(aes(x = year, y = number,
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_rect(aes(xmin = "2007", xmax = "2009", ymin = -Inf, ymax = Inf), alpha = .05, color = NA, fill = "#f5f5f5") +
  annotate("text", x = 10.2, y = 80000, size = 3.5, hjust = 0, color = "#333333",
           label =
"Economic Recession 
(2007-2009)") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.8, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_color_manual(values = two_category_palette) +
  scale_y_continuous(limits = c(30000,90000),
                     label = comma,
                     name = "Income Per Capita") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "", linetype = "", fill = "")
```

### Youth Labor Force Participation and Unemployment {.tabset}

#### Trends

##### Percent of Youth (15-24) Participating in the Labor Force for Albemarle County, City of Charlottesville, and Virginia
```{r}
youth_employment <- read_csv("../data/youth_employment_status.csv")

youth_employment <- youth_employment %>% 
  mutate(locality = recode(name,
                          "Albemarle County, Virginia" = "Albemarle",
                          "Charlottesville city, Virginia" = "Charlottesville"),
         survey_period = paste0(as.character(year-5), "-", as.character(year)),
         label_labor = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round(laborforce_rate, digits = 0)), "%"), NA),
         label_unempl = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round(unemployment_rate, digits = 0)), "%"), NA))

youth_employment %>%
  ggplot(aes(x = survey_period, y = laborforce_rate, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label_labor),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### Percent of Youth (15-24) in the Labor Force Experiencing Unemployment for Albemarle County, City of Charlottesville, and Virginia
```{r}
youth_employment %>%
  ggplot(aes(x = survey_period, y = unemployment_rate, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label_unempl),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Youth in Labor Force") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### Children Living below Poverty Threshold {.tabset}

#### Trends
##### Percent of Children (0-17) Living below the Poverty Threshold for Albemarle County, City of Charlottesville, and Virginia
```{r}
child_poverty <- read_csv("../data/child_pov.csv")
child_poverty <- child_poverty %>%
  mutate(locality = ifelse(county_fips == "000", "Virginia",
                       ifelse(county_fips == "003", "Albemarle",
                              ifelse(county_fips == "540", "Charlottesville", "Unknown"))),
         year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         paste0(as.character(round(pct_child_pov, digits = 0)), "% (n=", formatC(num_child_pov, format="d", big.mark=","),")"), NA))

child_poverty %>% 
  ggplot(aes(x = year, y = pct_child_pov, color = locality, group = locality)) +
  geom_vline(xintercept = "2020", linetype = 2, color = "#333333") +
  geom_vline(xintercept = "2021", linetype = 2, color = "#333333") +
  annotate("text", x = 16.7, y = 85, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"COVID-19 Economic
Stimulus Payments") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 3.5, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Children") + 
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Students Identified as Economically Disadvantaged {.tabset}

#### Trends
##### Percent of Students Identified as Economically Disadvantaged (eligible for free or reduced meals, eligible for TANF, Medicaid and/or Head Start, or identified as from a migrant family, experiencing homelessness, or in foster care) for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
economically_disadvantaged_students <- read_csv("../data/economically_disadvantaged_students.csv")
economically_disadvantaged_students <- economically_disadvantaged_students %>% 
  mutate(division_name = recode(division_name,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division_name %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         paste0(as.character(round(percent, digits = 0)), "% (n=", formatC(economically_disadvantaged_students, format="d", big.mark=","),")"), NA))

economically_disadvantaged_students %>%
  ggplot(aes(x = school_year, y = percent, color = division_name, group = division_name)) +
  geom_vline(xintercept = "2018-19", linetype = 2, color = "#333333") +
  annotate("text", x = 15.1, y = 70, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"CCS begin 
participating 
in USDA CEP") +
  geom_vline(xintercept = "2021-22", linetype = 2, color = "#333333") +
  annotate("text", x = 18.1, y = 10, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"ACPS begin 
participating 
in USDA CEP") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Students") + 
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position="top") +
  labs(color = "")
```


### Cost-Burdened Households (Renters and Homeowners) {.tabset}

#### Trends
##### Percent of Renters Paying more than 30% of their Income on Housing (Rent and Utilities) for Albemarle County, City of Charlottesville, and Virginia
```{r}
rent_burdened <- read_csv("../data/rent_burdened.csv")
rent_burdened <- rent_burdened %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year)),
         label = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round((percent_over_30*100), digits = 0)), "%"), NA))
rent_burdened %>% 
  ggplot(aes(x = survey_period, y = percent_over_30, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent, 
                     name = "Percent of Renters") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


##### Percent of Homeowners Paying more than 30% of their Income on Housing (Mortgage payments, Taxes, Insurance, and Utilities) for Albemarle County, City of Charlottesville, and Virginia
```{r}
homeowner_burden <- read_csv("../data/homeowner_burden.csv")
homeowner_burden <- homeowner_burden %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year)),
         label = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round(pct_burden, digits = 0)), "%"), NA))

homeowner_burden %>% 
  ggplot(aes(x = survey_period, y = pct_burden, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Homeowners") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### People Experiencing Homelessness {.tabset}

#### Trends
##### Point-in-Time Count of People Experiencing Homelessness for the Charlottesville Region, conducted yearly in January
```{r}
pitcount_homeless <- read_csv("../data/pitcount_homeless.csv")
pitcount_homeless <- pitcount_homeless %>% 
  mutate(year = as.character(year),
         locality = "Charlottesville Region",
         type = recode(type,
                       "unsheltered_total_persons" = "Unsheltered",
                       "sheltered_total_persons" = "Sheltered",
                       "total_persons" = "Total"),
         label = ifelse(year %in% str_sort_last(year),
                         as.character(count), NA))

pitcount_homeless %>% 
  ggplot(aes(x = year, y = count, 
             color = locality, 
             group = interaction(locality, type), 
             linetype = type)) +
  geom_vline(xintercept = "2012", linetype = 2, color = "#333333") +
  annotate("text", x = 4.2, y = 100, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Opening of The Crossings
(permanent supportive housing)") +
  geom_vline(xintercept = "2022", linetype = 2, color = "#333333") +
  annotate("text", x = 10.2, y = 275, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"COVID-19 pandemic hightened
impact of high housing costs 
and lack of affordable housing") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_linetype_manual(values = c(2, 6, 1),
                        limits = c("Sheltered", "Unsheltered", "Total")) +
  scale_color_manual(values = one_category_palette) +
  scale_y_continuous(limits = c(0,300),
                     label = comma,
                     name = "Number of People") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position="top") +
  labs(color = "", linetype = "")
```


## Health and Family Stability

### Prenatal Care {.tabset}

#### Trends
##### Percent of People Giving Birth with Access to Prenatal Care for Albemarle County, City of Charlottesville, and Virginia
```{r}
prenatal_first_trimester <- read_csv("../data/prenatal_first_trimester.csv")
prenatal_first_trimester <- prenatal_first_trimester %>%
  mutate(percent_access_to_prenatal_care = 100 - late_no_prenatal_to_birthrates,
          year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         paste0(as.character(round(percent_access_to_prenatal_care, digits = 0)), "%"), NA))

prenatal_first_trimester %>%
  ggplot(aes(x = year, y = percent_access_to_prenatal_care, color = locality, group = locality)) +
  geom_vline(xintercept = "2010", linetype = 2, color = "#333333") +
  annotate("text", x = 5.2, y = 80, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Affordable Care 
Act (ACA) passed") +
  geom_vline(xintercept = "2019", linetype = 2, color = "#333333") +
  annotate("text", x = 11.5, y = 85, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Virginia expanded 
Medicaid coverage") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(40, 100),
                     labels = label_percent(scale = 1), 
                     name = "Percent of People Giving Birth") + 
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position="top") +
  labs(color = "")
```

### Low Birth-Weight Infants {.tabset}

#### Trends
##### Percent of Infants Born Weighing Under 2,500 grams (5.5 lbs) for Albemarle County, City of Charlottesville, and Virginia
```{r}
low_birth_weight <- read_csv("../data/low_birth_weight.csv")
low_birth_weight <- low_birth_weight %>%
  filter(!year %in% c(2000, 2020)) %>% 
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1)),
         label = ifelse((!locality %in% "Virginia") & (three_yr_period %in% str_sort_last(three_yr_period)),
                         paste0(as.character(round(pct_3yr, digits = 0)), "%"), NA))

low_birth_weight %>%
  ggplot(aes(x = three_yr_period, y = pct_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Infant Deaths {.tabset}

#### Trends
##### Percent of Infants who Died before their 1st Birthday for Albemarle County, City of Charlottesville, and Virginia
```{r}
infant_mortality <- read_csv("../data/infant_mortality.csv")
infant_mortality <- infant_mortality %>%
  filter(!year %in% c(2000, 2020)) %>% 
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                       "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1)),
         label = ifelse((!locality %in% "Virginia") & (three_yr_period %in% str_sort_last(three_yr_period)),
                         paste0(as.character(round(rate_3yr, digits = 0)), "%"), NA))

infant_mortality %>% 
  ggplot(aes(x = three_yr_period, y = rate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 60),
                     labels = label_percent(scale = 1), 
                     name = "Percent of Infants") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### Teen Pregnancies and Births to Teens {.tabset}

#### Trends
##### Rate of Pregnancies for Teens, Ages 15-17, for Albemarle County, City of Charlottesville, and Virginia
```{r}
teen_pregnancy_birth <- read_csv("../data/teen_pregnancy_birth.csv")
teen_pregnancy_birth <- teen_pregnancy_birth %>%
  filter(!year %in% c(2000, 2020)) %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville",
                          "Commonwealth Of Virginia" = "Virginia"),
         three_yr_period = paste0(as.character(year-1),"-",as.character(year+1)),
         label_preg = ifelse((!locality %in% "Virginia") & (three_yr_period %in% str_sort_last(three_yr_period)),
                         as.character(round(pregnancyrate_3yr, digits = 0)), NA),
         label_birth = ifelse((!locality %in% "Virginia") & (three_yr_period %in% str_sort_last(three_yr_period)),
                         as.character(round(birthsrate_3yr, digits = 0)), NA))

teen_pregnancy_birth %>% 
  ggplot(aes(x = three_yr_period, y = pregnancyrate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label_preg),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100), 
                     name = "Rate per 1,000 Teens (15-17)") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### Rate of Births to Teens, Ages 15-17, for Albemarle County, City of Charlottesville, and Virginia 
```{r}
teen_pregnancy_birth %>% 
  ggplot(aes(x = three_yr_period, y = birthsrate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label_birth),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100), 
                     name = "Rate per 1,000 Teens (15-17)") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Sexually Transmitted Infections in Youth {.tabset}

#### Trends
##### Rate of Sexually Transmitted Infections in Youth, Ages 10-19, for Albemarle County, City of Charlottesville, and Virginia
```{r}
youth_sti <- read_csv("../data/youth_sti.csv")
youth_sti <- youth_sti %>% 
  mutate(label = ifelse((!locality %in% "Virginia") & (year3 %in% str_sort_last(year3)),
                         as.character(round(total_incrate_3yr, digits = 0)), NA))

youth_sti %>%
  ggplot(aes(x = year3, y = total_incrate_3yr, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .9, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 100),
                     name = "Rate per 1,000 Youth (10-19)") + 
  scale_x_discrete(name = "Three-Year Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Children in Two-Parent Households {.tabset}

#### Trends
##### Percent of Children in Two-Parent Households for Albemarle County, City of Charlottesville, and Virginia
```{r}
children_twoparents <- read_csv("../data/children_twoparents.csv")
children_twoparents <- children_twoparents %>%
  mutate(locality = str_remove(NAME, " County, Virginia| city, Virginia"), 
         locality = str_trim(locality),
         survey_period = paste0(as.character(year-5), "-", as.character(year)),
         label = ifelse((!locality %in% "Virginia") & (survey_period %in% str_sort_last(survey_period)),
                         paste0(as.character(round((percent*100), digits = 0)), "%"), NA))

children_twoparents %>% 
  ggplot(aes(x = survey_period, y = percent, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .8, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0, 1),
                     labels = scales::percent, 
                     name = "Percent of Children") + 
  scale_x_discrete(name = "ACS Survey Period") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Divorce {.tabset}

#### Trends
##### Rate of Divorce for Albemarle County, City of Charlottesville, and Virginia (Source: Virginia Department of Health)
```{r}
divorce_vdh <- read_csv("../data/divorce_vdh.csv")
divorce_vdh <- divorce_vdh %>%
  mutate(locality = recode(locality,
                          "Albemarle County" = "Albemarle",
                          "Charlottesville City" = "Charlottesville"),
         year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(divorce_rate, digits = 1)), NA))

divorce_vdh %>% 
  ggplot(aes(x = year, y = divorce_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .9, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,10),
                     breaks = c(0,2,4,6,8,10),
                     name = "Rate per 1000 People") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### Rate of Divorce for Albemarle County, City of Charlottesville, and Virginia (Source: Virginia Circuit Court)
```{r}
divorce_circuit <- read_csv("../data/divorce_circuit.csv")
dc_missing <- data.frame(locality = c("Virginia", "Virginia", "Virginia", "Virginia", "Virginia", "Virginia"),
                       year = c(2014, 2015, 2016, 2017, 2018, 2019))
divorce_circuit <- divorce_circuit %>% 
  bind_rows(dc_missing) %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(divorce_rate, digits = 1)), NA))

divorce_circuit %>% 
  ggplot(aes(x = year, y = divorce_rate, 
             color = locality, 
             group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1.1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,10),
                     breaks = c(0,2,4,6,8,10),
                     name = "Rate per 1000 People") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### Assessments and Investigations by Child Protective Services {.tabset}

#### Trends
##### Rate of Referrals to Child Protective Services Accepted for Assessment or Investigation by Fiscal Year (12mo. period measured from July 1st through June 30th) for Albemarle County, City of Charlottesville, and Virginia
```{r}
child_welfare_reports <- read_csv("../data/child_welfare_reports.csv")
child_welfare_reports <- child_welfare_reports %>%
  mutate(fiscal_year = paste0(as.character(year-1),"-",as.character(year)),
         fiscal_year = str_replace_all(fiscal_year, "-20", "-"),
         # year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (fiscal_year %in% str_sort_last(fiscal_year)),
                         as.character(round(cps_rate, digits = 0)), NA))

child_welfare_reports %>% 
  ggplot(aes(x = fiscal_year, y = cps_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000 Children") +
  scale_x_discrete(name = "Fiscal Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


### Children in Foster Care {.tabset}

#### Trends
##### Rate of Children in Foster Care, Measured Yearly on October 1st, for Albemarle County, City of Charlottesville, and Virginia
```{r}
foster_care <- read_csv("../data/foster_care.csv")
foster_care <- foster_care %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(fc_rate, digits = 0)), NA))

foster_care %>% 
  ggplot(aes(x = year, y = fc_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .6, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000 Children") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```


## School and Community Disciplinary Actions

### School Reports of Discipline {.tabset}

#### Trends

##### Rate of Incidents of Alcohol and Drug Violations for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
school_alcdrugs_dcv <- read_csv("../data/school_alcdrugs_dcv.csv")
school_alcdrugs_dcv <- school_alcdrugs_dcv %>% 
  mutate(school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         as.character(round(rate, digits = 1)), NA))

school_alcdrugs_dcv %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate of Incidents per 1000 Students") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```
 
##### Rate of Incidents of Physical Violence for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
school_violence_dcv <- read_csv("../data/school_violence_dcv.csv")
school_violence_dcv <- school_violence_dcv %>% 
  mutate(school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         as.character(round(rate, digits = 1)), NA))

school_violence_dcv %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate of Incidents per 1000 Students") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

##### Rate of Incidents of Weapons Possession for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
school_weapons_dcv <- read_csv("../data/school_weapons_dcv.csv")
school_weapons_dcv <- school_weapons_dcv %>% 
  mutate(school_year = str_replace_all(school_year, "-20", "-"),
         label = ifelse((!division %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         as.character(round(rate, digits = 1)), NA))

school_weapons_dcv %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate of Incidents per 1000 Students") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Out-of-School Suspensions {.tabset}

#### Trends

##### Rate of Out-of-School Suspensions (Short-term Suspension, Long-term Suspension, or Modified Expulsion to Suspension) for Albemarle County Public Schools, Charlottesville City Schools, and Virginia Public Schools
```{r}
school_suspensions <- read_csv("../data/school_suspensions.csv")
school_suspensions <- school_suspensions %>% 
  mutate(label = ifelse((!division %in% "Virginia") & (school_year %in% str_sort_last(school_year)),
                         as.character(round(rate, digits = 1)), NA))

school_suspensions %>%
  ggplot(aes(x = school_year, y = rate, 
             color = division, group = division)) +
  geom_vline(xintercept = "2016-17", linetype = 2, color = "#333333") +
  annotate("text", x = 14.2, y = 350, size = 3.5, hjust = 0, color = "#333333", 
           label = 
"Replicable with 
available SSIR data") +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_linetype_manual(values = c(2, 1)) +
  scale_y_continuous(limits = c(0,500),
                     name = "Rate per 1000 Students") +
  scale_x_discrete(name = "School Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "", linetype = "")
```


### Children in Need of Services or Supervision {.tabset}

#### Trends

##### Rate of Youth (Age 10-17) in Need of Services or Supervision for Albemarle County, City of Charlottesville, and Virginia
```{r}
child_need_services <- read_csv("../data/child_need_services.csv")
child_need_services <- child_need_services %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(rate, digits = 1)), NA))

child_need_services %>% 
  ggplot(aes(x = year, y = rate, color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .7, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,100),
                     name = "Rate per 1000 Youth (10-17)") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Juvenile Delinquency Judgments {.tabset}

#### Trends

##### Rate of Juvenile Delinquency Judgments for Youth, Age 10-17, for Albemarle County, City of Charlottesville, and Virginia
```{r}
juvenile_delinquency <- read_csv("../data/juvenile_delinquency.csv")
juvenile_delinquency <- juvenile_delinquency %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(rate, digits = 0)), NA))

juvenile_delinquency %>% 
  ggplot(aes(x = year, y = rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = .3, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,150),
                     name = "Rate per 1000 Youth (10-17)") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Underage Alcohol Arrests {.tabset}

#### Trends

##### Rate of Underage Alcohol Arrests for Youth Under 18 for Albemarle County, City of Charlottesville, and Virginia
```{r}
arrests_alcoholrelated <- read_csv("../data/arrests_alcoholrelated.csv")
arrests_alcoholrelated <- arrests_alcoholrelated %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(arr_rate, digits = 1)), NA))

arrests_alcoholrelated %>% 
  ggplot(aes(x = year, y = arr_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000 Youth (Under 18)") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

### Arrests for Violent Crimes {.tabset}

#### Trends

##### Rate of Arrests for Crimes against Persons for Youth Under 18 for Albemarle County, City of Charlottesville, and Virginia
```{r}
arrests_crimesagainstpersons <- read_csv("../data/arrests_crimesagainstpersons.csv")
arrests_crimesagainstpersons <- arrests_crimesagainstpersons %>%
  mutate(year = as.character(year),
         label = ifelse((!locality %in% "Virginia") & (year %in% str_sort_last(year)),
                         as.character(round(arr_rate, digits = 1)), NA))

arrests_crimesagainstpersons %>% 
  ggplot(aes(x = year, y = arr_rate, 
             color = locality, group = locality)) +
  geom_line() +
  geom_point() +
  geom_text_repel(aes(label = label),
                  size = 3.5, fontface = "bold", nudge_x = 1, show.legend = FALSE, min.segment.length = Inf) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,50),
                     name = "Rate per 1000 Youth (Under 18)") +
  scale_x_discrete(name = "Year") +
  theme_minimal() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_text(margin = margin(t = 12)),
        legend.position = "top") +
  labs(color = "")
```

# Supplemental Report
### School Suspensions  {.tabset}

#### Trends
```{r fig.height=8, fig.width=10}

library(stats)
library(ggpubr)
library(plotrix)

# reading in data
nonprekVAall <- read.csv("../data/school_suspension_CRDCnonprek.csv")

nonprekVAall$OSS_Total <- rowSums(nonprekVAall[,c('OSS_Black','OSS_Hispanic','OSS_White','OSS_TwoOrMore', 'OSS_Asian')], na.rm = T)

nonprekVAall$totalstudents <- nonprekVAall$num_Total

nonprekVAall <- nonprekVAall %>%
  filter(Year != 2009)

## Re-shaping them to long format 
k12long_count_oss <- pivot_longer(nonprekVAall, cols = c('num_Black', 'num_Hispanic', 'num_White',
                                                         'num_TwoOrMore', 'num_Asian', 'num_Total',
                                                         'OSS_Black', 'OSS_Hispanic', 'OSS_White',
                                                         'OSS_TwoOrMore','OSS_Asian', 'OSS_Total'),
                                  names_to = c('.value','Race'),
                                  names_pattern = '(.+)_(Black|White|Hispanic|Asian|TwoOrMore|Total)')

k12long_count_oss$Race <- ifelse(k12long_count_oss$Race == "TwoOrMore", "Two or more", k12long_count_oss$Race)

# Calculating the percent of students suspended in each racial group 
k12long_count_oss$percsus <- round(k12long_count_oss$OSS / k12long_count_oss$num * 100, 2)
# Calculating the percent of the students enrolled in each racial group 
k12long_count_oss$percenroll <- round(k12long_count_oss$num / k12long_count_oss$totalstudents * 100, 2)

# Making NA rows for breaking up lines in ggplot 
# with the new way I code years later, 2010, 2012, 2014, and 2016 should all be NA years
yrs <- c(2012, 2014, 2016)
blanks <- data.frame(n = 1:3)
cols <- c("Year", "Race", "meanpercsus", "se", "meanperenroll", "meanenroll", "totalsus", "lessthan")
blanks[cols] <- NA
blanks$Year <- yrs
blanks <- blanks %>%
  select(-n)

# Calculating means by race and year for plotting 
k12OSSmeans <- k12long_count_oss %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(k12OSSmeans$Year), totalsus = k12OSSmeans$meanpercsus[k12OSSmeans$Race == "Total"])
k12OSSmeans <- merge(k12OSSmeans, totalsusovertime, by = 'Year')
k12OSSmeans$lessthan <- ifelse(k12OSSmeans$meanenroll < (100 / k12OSSmeans$totalsus), TRUE, FALSE)
k12OSSmeans <- k12OSSmeans %>%
  filter(lessthan == FALSE)

k12OSSmeans <- rbind(k12OSSmeans, blanks)

k12OSSmeans$Locality <- "Virginia"

# Charlottesville = CHARLOTTESVILLE CTY PBLC SCHS
# Albemarle = ALBEMARLE CO PBLC SCHS

albk12 <- k12long_count_oss %>%
  filter(LEA == "ALBEMARLE CO PBLC SCHS")

cvillek12 <- k12long_count_oss %>%
  filter(LEA == "CHARLOTTESVILLE CTY PBLC SCHS")

# Albemarle
# Calculating means by race and year for plotting 
albk12OSSmeans <- albk12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(albk12OSSmeans$Year), totalsus = albk12OSSmeans$meanpercsus[albk12OSSmeans$Race == "Total"])
albk12OSSmeans <- merge(albk12OSSmeans, totalsusovertime, by = 'Year')
albk12OSSmeans$lessthan <- ifelse(albk12OSSmeans$meanenroll < (100 / albk12OSSmeans$totalsus), TRUE, FALSE)
albk12OSSmeans <- albk12OSSmeans %>%
  filter(lessthan == FALSE)

albk12OSSmeans <- rbind(albk12OSSmeans, blanks)

albk12OSSmeans$Locality <- "Albemarle"

# creating weird year variable for plotting
albk12OSSmeans$Year <- ifelse(albk12OSSmeans$Year == 2011, 2010.7,
                                     ifelse(albk12OSSmeans$Year == 2013, 2012.7,
                                            ifelse(albk12OSSmeans$Year == 2015, 2014.7,
                                                   ifelse(albk12OSSmeans$Year == 2017, 2016.7, albk12OSSmeans$Year))))

# Cville
cvillek12OSSmeans <- cvillek12 %>%
  group_by(Year, Race) %>%
  summarise(meanpercsus = round(weighted.mean(percsus, num, na.rm = T), 2),
            se = std.error(percsus, na.rm = T),
            meanperenroll = round(mean(percenroll, na.rm = T), 2),
            meanenroll = mean(num))

# Filtering for racial groups whose enrollment is large enough that we would expect at least one 
# suspension if rates were equitable across racial groups 
totalsusovertime <- data.frame(Year = unique(cvillek12OSSmeans$Year), totalsus = cvillek12OSSmeans$meanpercsus[cvillek12OSSmeans$Race == "Total"])
cvillek12OSSmeans <- merge(cvillek12OSSmeans, totalsusovertime, by = 'Year')
cvillek12OSSmeans$lessthan <- ifelse(cvillek12OSSmeans$meanenroll < (100 / cvillek12OSSmeans$totalsus), TRUE, FALSE)
cvillek12OSSmeans <- cvillek12OSSmeans %>%
  filter(lessthan == FALSE)

cvillek12OSSmeans <- rbind(cvillek12OSSmeans, blanks)

cvillek12OSSmeans$Locality <- "Charlottesville"

# creating weird year variable for plotting
cvillek12OSSmeans$Year <- ifelse(cvillek12OSSmeans$Year == 2011, 2011.3,
                                     ifelse(cvillek12OSSmeans$Year == 2013, 2013.3,
                                            ifelse(cvillek12OSSmeans$Year == 2015, 2015.3,
                                                   ifelse(cvillek12OSSmeans$Year == 2017, 2017.3, cvillek12OSSmeans$Year))))

dat <- rbind(k12OSSmeans, albk12OSSmeans, cvillek12OSSmeans)

### Plots 
# all levels together 
# ggplot() + geom_point(data = dat, aes(Year, meanpercsus, shape = Locality, color = Race),
#                       position = 'identity', size = 3.5) + 
#   geom_line(data = dat,aes(x = Year, y = meanpercsus, group = Locality),
#             color = 'gray') +
#   xlab("Year") + ylab("Average % of students receiving OSS")  + 
#   ggtitle("") + scale_x_continuous(breaks = seq(2011, 2017, by = 2)) + 
#   theme_bw()+ 
#   scale_colour_discrete(na.translate = F) +
#   labs(caption = "Note: Racial groups were only included for a given year and locality when the average
#        number of students enrolled was high enough such that you would expect to see at least one suspension
#        if the average overall rate were true for each racial group")+
#   theme(plot.caption = element_text(hjust=0))


### Plots  adjust shape and color
## years are fall year, create school year +1
# all levels together 

dat <- dat %>% 
  mutate(Race = factor(Race, levels = c("Asian", "Black", "Hispanic", "Two or more", "White", "Total"), labels = c("Asian", "Black", "Hispanic", "Two or More", "White", "Total")))

dat %>% 
  # filter(!is.na())
ggplot(aes(x = Year, y = meanpercsus, group = Locality, shape = Race, color = Locality)) + 
  geom_line(size = 0.4) +
  geom_point(position = 'identity', size = 3.5) + 
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,15),
                     breaks = seq(0, 15, by = 5),
                     labels = label_percent(scale = 1)) +
  xlab("School Year") + ylab("Average % of students receiving OSS")  + 
  ggtitle("") + scale_x_continuous(breaks = seq(2011, 2017, by = 2)) + 
  theme_minimal() +
  scale_shape_manual(values = c(15,16,17,7,18,8),
                     na.translate = FALSE) +
  labs(color = "", shape = "", caption = "Note: Racial groups were only included for a given year and locality when the average number of 
  students enrolled was high enough such that you would expect to see at least one suspension if 
  the average overall rate were true for each racial group")+
  theme(text = element_text(size = 16), 
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)))

dat %>% 
  mutate(pt_label = substr(Race, 1,1)) %>% 
  # filter(!is.na())
ggplot() + 
  geom_line(aes(x = Year, y = meanpercsus, group = Locality, shape = Race, color = Locality), size = 0.5) +
  geom_point(aes(x = Year, y = meanpercsus, group = Locality, color = Locality), position = 'identity', size = 6) +
  geom_point(aes(x = Year, y = meanpercsus, group = Locality, shape = Race), color = "white", position = 'identity', fontface = "bold", size = 4) +
  # geom_text(aes(label = pt_label), color = "white", size = 3) +
  # geom_label(aes(label = pt_label, fill = Locality), colour = "white", fontface = "bold") +
  # scale_fill_manual(values = three_category_palette) +
  scale_color_manual(values = three_category_palette) +
  scale_y_continuous(limits = c(0,15),
                     breaks = seq(0, 15, by = 5),
                     labels = label_percent(scale = 1)) +
  xlab("School Year") + ylab("Average % of students receiving OSS")  + 
  ggtitle("") + scale_x_continuous(breaks = seq(2011, 2017, by = 2)) + 
  theme_minimal() +
  scale_shape_manual(values = c("\U0041","\U0042","\U0048","\U0054","\U0057","\U002A"), na.translate = FALSE) +
  labs(color = "", fill = "", shape = "", caption = "Note: Racial groups were only included for a given year and locality when the average number of 
  students enrolled was high enough such that you would expect to see at least one suspension if 
  the average overall rate were true for each racial group")+
  theme(text = element_text(size = 16), 
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)))


```

### Post-Secondary Education  {.tabset}

#### Trends
##### Enrollment in Any Post-Secondary Education
```{r fig.width=12, fig.height=9}

dat <- read.csv("../data/postsecondary_education_race.csv")

# ggplot can only have 6 unique shapes, and we have 9 racial categories
# I'm filtering out a couple for now
dat <- dat %>%
  filter(group != "Race Unknown") %>%
  filter(group != "Native Hawaiian")

# ..................................................
# Need to calculate the overall averages for each year to show in plot 

totals <- dat %>%
  group_by(year, locality) %>%
  summarise(cohortsize = sum(cohortsize, na.rm = T),
            enrolledany = sum(enrolledany, na.rm = T),
            enrolled4yr = sum(enrolled4yr, na.rm = T)) %>%
  mutate(percent_any = round(enrolledany / cohortsize * 100, 2),
         percent_4yr = round(enrolled4yr / cohortsize * 100, 2)) 

totals$group <- "Total"

plotdat <- rbind(dat, totals)

plotdat$group <- ifelse(plotdat$group == "2 or More", "Two or more", plotdat$group)

# Making NA rows for breaking up lines in ggplot 
# with the new way I code years later, 2010, 2012, 2014, and 2016 should all be NA years
yrs <- rep(c(2016.1, 2017.1, 2018.1, 2019.1, 2020.1, 2008.1, 2009.1, 2010.1, 2011.1, 2012.1, 2013.1, 2014.1, 2015.1), 3)
locality <- rep(c("Albemarle", "Charlottesville", "Virginia"), 13)
blanks <- data.frame(n = 1:39)
cols <- c("group", "cohortsize", "enrolledany", "enrolled4yr", "percent_any", "percent_4yr", "totalenrollperc", "lessthan")
blanks[cols] <- NA
blanks$year <- yrs
blanks$locality <- locality
blanks <- blanks %>%
  select(-n)

# Have to re-code years for the different localities separately and then re-bind the data frames together

plotdat$year <- ifelse(plotdat$locality == "Albemarle", plotdat$year - 0.2, 
                       ifelse(plotdat$locality == "Charlottesville", plotdat$year + 0.2, plotdat$year))
# ..................................................
# Creating plots

#### 4-year enrollment

# Filtering for racial groups whose group is large enough that we would expect at least one 
# student to enroll in 4-year college if total rate were equal across racial groups 
totalstime4yr <- data.frame(year = unique(plotdat$year), totalenrollperc = plotdat$percent_4yr[plotdat$group == "Total"])
plotdat4yr <- merge(plotdat, totalstime4yr, by = 'year')
plotdat4yr$lessthan <- ifelse(plotdat4yr$cohortsize < (100 / plotdat4yr$enrolled4yr), TRUE, FALSE)
plotdat4yr <- plotdat4yr %>%
  filter(lessthan == FALSE)

plotdat4yr <- plotdat4yr %>%
  filter(group != "Total")

plotdat4yr <- rbind(plotdat4yr, blanks)

# ggplot() + geom_point(data = plotdat4yr, aes(year, percent_4yr, shape = group, color = locality),
#                       position = 'identity', size = 3.5) + 
#   geom_line(data = plotdat4yr,aes(x = year, y = percent_4yr, group = locality),
#             color = 'gray') +
#   xlab("Year") + ylab("Pecent of students")  + 
#   ggtitle("") + scale_x_continuous(breaks = seq(2008, 2020, by = 1)) + 
#   theme_bw()+ 
#   scale_shape_discrete(na.translate = F) +
#   labs(caption = "Note: Racial groups were only included for a given year and locality when the number of students enrolled 
#   was high enough such that you would expect to see at least one student enrolled in a 4-year institution if the 
#   overall rate were true for each racial group")+
#   theme(plot.caption = element_text(hjust=0))


#### Any enrollment

# Filtering for racial groups whose group is large enough that we would expect at least one 
# student to enroll in 4-year college if total rate were equal across racial groups 
totalstimeAny <- data.frame(year = unique(plotdat$year), totalenrollperc = plotdat$percent_any[plotdat$group == "Total"])
plotdatAny <- merge(plotdat, totalstimeAny, by = 'year')
plotdatAny$lessthan <- ifelse(plotdatAny$cohortsize < (100 / plotdatAny$enrolled4yr), TRUE, FALSE)
plotdatAny <- plotdatAny %>%
  filter(lessthan == FALSE)

plotdatAny <- plotdatAny %>%
  filter(group != "Total")

plotdatAny <- rbind(plotdatAny, blanks)

plotdatAny <- plotdatAny %>% 
  mutate(group = factor(group, levels = c("American Indian", "Asian", "Black", "Hispanic", "Two or more", "White"), labels = c("American Indian", "Asian", "Black", "Hispanic", "Two or More", "White")))

plotdatAny %>% 
ggplot(aes(x = year, y = percent_any, group = locality, shape = group, color = locality)) + 
  geom_line(size = 0.4) +
  geom_point(position = 'identity', size = 3.5) + 
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(breaks = seq(2008, 2020, by = 1)) +
  scale_y_continuous(limits = c(40,100),
                     breaks = seq(40, 100, by = 10),
                     labels = label_percent(scale = 1)) +
  xlab("Year") + ylab("Percent of Students")  + 
  ggtitle("") +  
  theme_minimal() +
  scale_shape_manual(values = c(23,15,16,17,7,18),
                     na.translate = FALSE) +
  labs(color = "", shape = "", caption = "Note: Racial groups were only included for a given year and locality when the number of students enrolled was high 
  enough such that you would expect to see at least one student enrolled in a 4-year institution if the overall rate
  were true for each racial group")+
  theme(text = element_text(size = 16), 
        axis.title.x = element_text(margin = margin(t=12)),
        plot.caption = element_text(hjust=0, margin = margin(t=12)))

```

### Low Birth-Weight Infants  {.tabset}

#### Trends
``` {r fig.height=6, fig.width=10}
lbw_race <- read.csv("../data/low_birth_weight_race.csv")
spaceframe <- data.frame(locality = c("Albemarle","Albemarle","Albemarle","Albemarle","Albemarle","Albemarle",
                                      "Charlottesville","Charlottesville","Charlottesville","Charlottesville","Charlottesville","Charlottesville",
                                      "Virginia","Virginia","Virginia","Virginia","Virginia","Virginia"),
                       year_space = c(2002,2005,2008,2011,2014,2017,
                                2002,2005,2008,2011,2014,2017,
                                2002,2005,2008,2011,2014,2017))

lbw_race <- lbw_race %>% 
  mutate(group = factor(group, levels = c("black", "white", "other", "all"), labels = c("Black", "White", "Other", "All")),
         locality = recode(locality, "Albemarle County" = "Albemarle",
                           "Charlottesville City" = "Charlottesville",
                           "Commonwealth Of Virginia" = "Virginia"),
         year_space = ifelse(locality == "Albemarle", year - 0.5, 
                       ifelse(locality == "Charlottesville", year + 0.5, 
                              year)),
         group = recode(group, "Other" = "All Others")
         # three_yr_period = paste0(as.character(year-1),"-",as.character(year+1))
         ) %>% 
  filter(year %in% c(2001,2004,2007,2010,2013,2016,2019)
    # three_yr_period %in% c("2000-2002", "2003-2005", "2006-2008", "2009-2011", "2012-2014", "2015-2017", "2018-2020")
    ) %>% 
  bind_rows(spaceframe)



lbw_race %>% 
  bind_rows(spaceframe) %>% 
ggplot(aes(x = year_space, y = percent_3yr, group = locality, shape = group, color = locality)) + 
  geom_line(size = 0.4) +
  geom_point(position = 'identity', 
             size = 3.5) + 
  scale_color_manual(values = three_category_palette) +
  scale_x_continuous(breaks = seq(2001, 2019, by = 3),
                     labels = c("2000-2002", "2003-2005", "2006-2008", "2009-2011", "2012-2014", "2015-2017", "2018-2020"),
                     name = "Three-Year Period") +
  # scale_x_discrete(name = "Three-Year Period") +
  scale_y_continuous(limits = c(0,17),
                     # breaks = seq(0, 100, by = 10),
                     labels = label_percent(scale = 1)) +
  xlab("Year") + ylab("Percent of Infants")  + 
  ggtitle("") +  
  theme_minimal() +
  scale_shape_manual(values = c(16,18,5,8),
                     na.translate = FALSE) +
  labs(color = "", shape = "")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        axis.title.x = element_text(margin = margin(t=12)),
        text = element_text(size = 16), 
        plot.caption = element_text(hjust=0))
```
